<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
    <head>
        <title>Grails Events</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />
        <link rel="stylesheet" href="../css/guide.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />        
        <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8" />

        <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.13/clipboard.min.js"></script>
    <script type="text/javascript">
function addJsClass(el) {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>

        <link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css" />        
        <link rel="stylesheet" type="text/css" href="../css/navbar.css" />
        <link rel="stylesheet" type="text/css" href="../css/stMenu.css" />      

    </head>

    <body class="body" onload="addJsClass();">

    <a href="https://github.com/grails/grails-core" target="_blank">
      <div id="fork-me">
        <p>Fork me on Github</p>
      </div>
    </a>
    <div id="st-container" class="st-container st-effect-9">
      <nav class="st-menu st-effect-9" id="menu-12">
        <h2 class="icon icon-lab">Socialize</h2>
        <ul>
          <li><a href="http://grails.org/mailing-lists.html" class="icon"><span class="fa fa-envelope"></span> Discuss on the Mailing List</a></li>
          <li><a href="http://slack-signup.grails.org" class="icon"><span class="fa fa-slack"></span> Discuss on Slack</a></li>
          <li><a href="https://twitter.com/grailsframework" class="icon"><span class="fa fa-twitter"></span> Grails on Twitter</a></li>
          <li><a href="http://grails.org/events.html" class="icon"><span class="fa fa-calendar"></span> Events and conferences</a></li>
          <li><a href="https://github.com/grails/grails-core" class="icon"><span class="fa fa-github"></span> Source code on GitHub</a></li>
          <li><a href="http://grails.org/contribute.html#reporting-issues" class="icon"><span class="fa fa-bug"></span> Report issues on Github</a></li>
          <li><a href="http://stackoverflow.com/questions/tagged/grails" class="icon"><span class="fa fa-stack-overflow"></span> Stack Overflow questions</a></li>
        </ul>
      </nav>
      <div class="st-pusher">
        <div class="st-content">
          <div class="st-content">
            <div class="grailsnavbar grailsnavbar-default">
              <div class="grailsnavbar-container">
                <div class="grailsnavbar-header">
                  <a class="grailsnavbar-brand" href="index.html"><i class="fa grails-icon"><img src="../img/grails-cupsonly-logo-white.svg"></i> Grails</a>
                </div>
                <a id="nav-icon" href="javascript:toggleNavIcon();">
                  <span></span>
                  <span></span>
                  <span></span>
                </a>
                <div class="grailsnavbar-collapse collapse">
                  <ul id="grailsnavbar-nav" class="grailsnavbar-nav grailsnavbar-right closemobile">
                    <li><a href="http://grails.org/learn.html">Learn</a></li>
                    <li><a href="http://guides.grails.org">Guides</a></li>
                    <li><a href="http://grails.org/documentation.html">Documentation</a></li>
                    <li><a href="http://grails.org/download.html">Download</a></li>
                    <li><a href="http://plugins.grails.org">Plugins</a></li>
                    <li><a href="http://grails.org/community.html">Community</a></li>
                    <li><a href="http://grails.org/support.html">Support</a></li>
                    <li><a data-effect="st-effect-9" class="st-trigger" href="#">Socialize</a></li>
                    <li><a href="http://grails.org/search.html"><i class="fa fa-search"></i></a></li>
                  </ul>
                </div>
              </div>
            </div>
            <!-- CONTENT -->
<table id="colset" border="0" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td id="col1">
                                        <div id="main" class="corner-all">

                                            <div class="project">
                                                <h1>Grails Events</h1>
                                                <p></p>
                                                <p>Grails Events to handle a common scenario. A user registers himself in an application and the app sends the user a welcome email.</p>
                                                <p><strong>Authors:</strong> Sergio del Amo</p>
                                                <p><strong>Grails Version:</strong> 3.3.0</p>

                                            </div>

                                            

<h1 id="gettingStarted">1 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In this guide, you are going to use <a href="https://async.grails.org/latest/guide/index.html#events">Grails Events</a> to handle a common scenario. A user registers in an application and the app sends the user a welcome email. For example, asking him to verify his email address.
We are going to trigger the Email Notification by publishing an event when the user is registered.</p>
</div>


<h2 id="requirements">1.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.7 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>


<h2 id="howto">1.2 How to complete the guide</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/howto.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To get started do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/grails-guides/grails-events/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository:<br>
<code>git clone <a href="https://github.com/grails-guides/grails-events.git" class="bare">https://github.com/grails-guides/grails-events.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Grails guides repositories contain two folders:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>initial</code>  Initial project. Often a simple Grails app with additional some code to give you a head-start.</p>
</li>
<li>
<p><code>complete</code> A completed example. It is the result of working through the steps presented by the guide and applying those changes to the <code>initial</code> folder.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To complete the guide, go to the <code>initial</code> folder</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cd</code> into <code>grails-guides/grails-events/initial</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and follow the instructions in the next sections.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can go right to the <strong>completed example</strong> if you <code>cd</code> into <code>grails-guides/grails-events/complete</code>
</td>
</tr>
</table>
</div>


<h1 id="writingTheApp">2 Writing the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Grails 3.3 introduces a new Events API that replaces the previous implementation that was based on Reactor 2.x (which is no longer maintained and deprecated).</p>
</div>
<div class="paragraph">
<p>In Grails 3.3 and above a new EventBus abstraction has been introduced. Like the PromiseFactory notion, there are implementations of the EventBus interface for common asynchronous frameworks like GPars and RxJava.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Your project already contains the events dependency:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:events</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Grails Events capabilites documentation can be found in <a href="https://async.grails.org/latest/guide/index.html#events">async.grails.org</a>.</p>
</div>


<h2 id="domain">2.1 Domain Classes</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/domain.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Add two domain classes.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/demo/User.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="type">class</span> <span class="class">User</span> {
    <span class="predefined-type">String</span> firstName
    <span class="predefined-type">String</span> lastName
    <span class="predefined-type">String</span> email

    <span class="directive">static</span> constraints = {
        firstName <span class="key">nullable</span>: <span class="predefined-constant">false</span>
        lastName <span class="key">nullable</span>: <span class="predefined-constant">false</span>
        email <span class="key">nullable</span>: <span class="predefined-constant">false</span>, <span class="key">email</span>: <span class="predefined-constant">true</span>, <span class="key">unique</span>: <span class="predefined-constant">true</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/demo/Notification.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="type">class</span> <span class="class">Notification</span> {
    <span class="predefined-type">String</span> email
    <span class="predefined-type">String</span> subject

    <span class="directive">static</span> constraints = {
        subject <span class="key">nullable</span>: <span class="predefined-constant">false</span>
        email <span class="key">nullable</span>: <span class="predefined-constant">false</span>, <span class="key">email</span>: <span class="predefined-constant">true</span>
    }
}</code></pre>
</div>
</div>


<h2 id="dataServices">2.2 Data Services</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/dataServices.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Introduced in GORM 6.1, <a href="http://gorm.grails.org/latest/hibernate/manual/index.html#dataServices">Data Services</a> take the work out of implemented service layer logic by adding the ability to automatically implement abstract classes or interfaces using GORM logic.</p>
</div>
<div class="paragraph">
<p>Add two data services classes for the previous domain classes.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/UserService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.services.Service</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@Service</span>(User)
<span class="annotation">@CompileStatic</span>
<span class="type">interface</span> UserService {
    <span class="type">int</span> count()
    <span class="type">void</span> deleteByEmail(<span class="predefined-type">String</span> email)
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/NotificationService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.services.Service</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@Service</span>(<span class="predefined-type">Notification</span>)
<span class="annotation">@CompileStatic</span>
<span class="type">interface</span> NotificationService {
    <span class="type">int</span> count()
    <span class="type">void</span> deleteByEmail(<span class="predefined-type">String</span> email)
}</code></pre>
</div>
</div>


<h2 id="urlMapping">2.3 Url Mapping</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/urlMapping.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Modify <code>UrlMappings</code> to map the endpoints which handle User registration.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/demo/UrlMappings.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">        <span class="string"><span class="delimiter">&quot;</span><span class="content">/signup</span><span class="delimiter">&quot;</span></span>(<span class="key">controller</span>: <span class="string"><span class="delimiter">'</span><span class="content">register</span><span class="delimiter">'</span></span>, <span class="key">action</span>: <span class="string"><span class="delimiter">'</span><span class="content">index</span><span class="delimiter">'</span></span>)
        <span class="string"><span class="delimiter">&quot;</span><span class="content">/register</span><span class="delimiter">&quot;</span></span>(<span class="key">controller</span>: <span class="string"><span class="delimiter">'</span><span class="content">register</span><span class="delimiter">'</span></span>, <span class="key">action</span>: <span class="string"><span class="delimiter">'</span><span class="content">save</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>/signup</code> presents a registration form.</p>
</div>
<div class="paragraph">
<p><code>/register</code> handles a POST submission which saves a user.</p>
</div>


<h2 id="view">2.4 View</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/view.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a GSP file which contains the user registration form.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/views/register/index.gsp</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;Sign Up&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">title&gt;</span></span><span class="error">
</span>    &lt;meta name=<span class="string"><span class="delimiter">&quot;</span><span class="content">layout</span><span class="delimiter">&quot;</span></span> content=<span class="string"><span class="delimiter">&quot;</span><span class="content">main</span><span class="delimiter">&quot;</span></span> /&gt;
    &lt;style type=<span class="string"><span class="delimiter">&quot;</span><span class="content">text/css</span><span class="delimiter">&quot;</span></span>&gt;
        ol li {
            list-style-<span class="key">type</span>: none;
            <span class="key">margin</span>: <span class="integer">10</span>px auto;
        }
        ol li label {
            <span class="key">width</span>: <span class="integer">120</span>px;
        }
    &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">style&gt;</span></span><span class="error">
</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">head&gt;</span></span><span class="error">
</span>&lt;body&gt;
&lt;div id=<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span> role=<span class="string"><span class="delimiter">&quot;</span><span class="content">main</span><span class="delimiter">&quot;</span></span>&gt;
    &lt;<span class="key">g</span>:hasErrors bean=<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>signUpInstance<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>&gt;
    &lt;ul <span class="type">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">errors</span><span class="delimiter">&quot;</span></span>&gt;
        &lt;<span class="class">g</span>:eachError bean=<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>signUpInstance<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>&gt;
            &lt;li&gt;&lt;<span class="key">g</span>:message error=<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span><span class="local-variable">it</span><span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>/&gt;&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">li&gt;</span></span><span class="error">
</span>        &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">g:eachError&gt;</span></span><span class="error">
</span>    &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">ul&gt;</span></span><span class="error">
</span>    &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">g:hasErrors&gt;</span></span><span class="error">
</span>    &lt;p <span class="type">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>&gt;<span class="error">$</span>{flash.message}&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">p&gt;</span></span><span class="error">
</span>
    &lt;h1&gt;&lt;<span class="key">g</span>:message code=<span class="string"><span class="delimiter">&quot;</span><span class="content">register.title</span><span class="delimiter">&quot;</span></span> <span class="keyword">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Register Form</span><span class="delimiter">&quot;</span></span>/&gt;&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">h1&gt;</span></span><span class="error">
</span>    &lt;<span class="key">g</span>:form controller=<span class="string"><span class="delimiter">&quot;</span><span class="content">register</span><span class="delimiter">&quot;</span></span> action=<span class="string"><span class="delimiter">&quot;</span><span class="content">save</span><span class="delimiter">&quot;</span></span> method=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>&gt;
        &lt;ol&gt;
            &lt;li&gt;
                &lt;label <span class="keyword">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>&gt;First <span class="predefined-type">Name</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">label&gt;</span></span><span class="error">
</span>                &lt;<span class="key">g</span>:textField name=<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span> id=<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>signUpInstance.firstName<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span> /&gt;
            &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">li&gt;</span></span><span class="error">
</span>            &lt;li&gt;
                &lt;label <span class="keyword">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>&gt;Last <span class="predefined-type">Name</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">label&gt;</span></span><span class="error">
</span>                &lt;<span class="key">g</span>:textField name=<span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span> id=<span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>signUpInstance.lastName<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span> /&gt;
            &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">li&gt;</span></span><span class="error">
</span>            &lt;li&gt;
                &lt;label <span class="keyword">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span>&gt;Email&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">label&gt;</span></span><span class="error">
</span>                &lt;<span class="key">g</span>:textField name=<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span> id=<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span> value=<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">${</span>signUpInstance.email<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span> /&gt;
            &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">li&gt;</span></span><span class="error">
</span>            &lt;li&gt;
                &lt;<span class="key">g</span>:submitButton name=<span class="string"><span class="delimiter">&quot;</span><span class="content">Submit</span><span class="delimiter">&quot;</span></span> id=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span>/&gt;
            &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">li&gt;</span></span><span class="error">
</span>
        &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">ol&gt;</span></span><span class="error">
</span>
    &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">g:form&gt;</span></span><span class="error">
</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">div&gt;</span></span><span class="error">
</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">body&gt;</span></span><span class="error">
</span>&lt;<span class="regexp"><span class="delimiter">/</span><span class="content">html&gt;</span></span></code></pre>
</div>
</div>


<h2 id="services">2.5 Services</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/services.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Add a service which handles the registration of a user in the database.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/RegisterService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.events.EventPublisher</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.Transactional</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">groovy.util.logging.Slf4j</span>

<span class="annotation">@CompileStatic</span>
<span class="annotation">@Slf4j</span>
<span class="type">class</span> <span class="class">RegisterService</span> <span class="directive">implements</span> EventPublisher { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Transactional</span>
    User register(RegisterCommand cmd) {
        <span class="predefined-type">String</span> email = cmd.email
        User user = cmd <span class="keyword">as</span> User
        <span class="keyword">if</span> ( !user.save() ) {
            log.error <span class="string"><span class="delimiter">'</span><span class="content">Unable to save user {}</span><span class="delimiter">'</span></span>, user.errors.toString()
            <span class="keyword">return</span> user
        }

        notify(<span class="string"><span class="delimiter">'</span><span class="content">userSaved</span><span class="delimiter">'</span></span>, email) <i class="conum" data-value="2"></i><b>(2)</b>
        user
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Implement explicitely  <a href="https://async.grails.org/latest/api/grails/events/EventPublisher.html">EventPublisher</a> trait</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instead of annotating the method with <code>@Publisher</code> which is usually the recommended approach to publish an event, we do it here manually with <code>notify</code> method.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We consume the event in a different service. The consumer is completely decoupled from the sender. In a real application you will probably send an email to the user who just registered asking him to verify his email address. In this guide, we save a <code>Notification</code> in the database.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/WelcomeEmailService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.events.annotation.Subscriber</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.Transactional</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">groovy.util.logging.Slf4j</span>

<span class="annotation">@Slf4j</span>
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">WelcomeEmailService</span> {

    <span class="annotation">@Transactional</span>
    <span class="annotation">@Subscriber</span>(<span class="string"><span class="delimiter">'</span><span class="content">userSaved</span><span class="delimiter">'</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="type">void</span> onUserSaved(<span class="predefined-type">String</span> email) {
        <span class="predefined-type">Notification</span> notification = <span class="keyword">new</span> <span class="predefined-type">Notification</span>(<span class="key">email</span>: email, <span class="key">subject</span>: <span class="string"><span class="delimiter">'</span><span class="content">Welcome to Grails App</span><span class="delimiter">'</span></span>)
        <span class="comment">// TODO Send Email</span>
        <span class="keyword">if</span> ( !notification.save() ) {
            log.error(<span class="string"><span class="delimiter">'</span><span class="content">unable to save notification {}</span><span class="delimiter">'</span></span>, notification.errors.toString())
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To consume an event use the <a href="https://async.grails.org/latest/api/grails/events/annotation/Subscriber.html">Subscriber</a> annotation. We use the event id to subscribe to.</td>
</tr>
</table>
</div>


<h2 id="controllers">2.6 Controller</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/controllers.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a Command Object to handle the form data binding and validation.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/demo/RegisterCommand.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.validation.Validateable</span>

<span class="type">class</span> <span class="class">RegisterCommand</span> <span class="directive">implements</span> Validateable {
    <span class="predefined-type">String</span> firstName
    <span class="predefined-type">String</span> lastName
    <span class="predefined-type">String</span> email

    <span class="directive">static</span> constraints = {
        firstName <span class="key">nullable</span>: <span class="predefined-constant">false</span>
        lastName <span class="key">nullable</span>: <span class="predefined-constant">false</span>
        email <span class="key">nullable</span>: <span class="predefined-constant">false</span>, <span class="key">email</span>: <span class="predefined-constant">true</span>
    }

    <span class="predefined-type">Object</span> asType(<span class="predefined-type">Class</span> clazz) {
        <span class="keyword">if</span> (clazz == User) {
            <span class="keyword">def</span> user = <span class="keyword">new</span> User()
            copyProperties(<span class="local-variable">this</span>, user)
            <span class="keyword">return</span> user
        }
        <span class="keyword">else</span> {
            <span class="local-variable">super</span>.asType(clazz)
        }
    }

    <span class="keyword">def</span> <span class="function">copyProperties</span>(source, target) {
        source.properties.each { key, value -&gt;
            <span class="keyword">if</span> (target.hasProperty(key) &amp;&amp; !(key <span class="keyword">in</span> [<span class="string"><span class="delimiter">'</span><span class="content">class</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">metaClass</span><span class="delimiter">'</span></span>])) {
                target[key] = value
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a controller with two actions, one action presents the registration form the other action handles the form submission.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/demo/RegisterController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">org.springframework.context.MessageSource</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">RegisterController</span> {

    <span class="directive">static</span> allowedMethods = [<span class="key">index</span>: <span class="string"><span class="delimiter">'</span><span class="content">GET</span><span class="delimiter">'</span></span>, <span class="key">save</span>: <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>]

    RegisterService registerService

    MessageSource messageSource

    <span class="keyword">def</span> <span class="function">index</span>() {
        [<span class="key">signUpInstance</span>:  <span class="keyword">new</span> RegisterCommand()]
    }

    <span class="keyword">def</span> <span class="function">save</span>(RegisterCommand cmd) {

        <span class="keyword">if</span> ( cmd.hasErrors() ) {
            render <span class="key">view</span>: <span class="string"><span class="delimiter">'</span><span class="content">index</span><span class="delimiter">'</span></span>, <span class="key">model</span>: [<span class="key">signUpInstance</span>: cmd]
            <span class="keyword">return</span>
        }

        User user = registerService.register(cmd)
        flash.message = messageSource.getMessage(<span class="string"><span class="delimiter">'</span><span class="content">user.saved</span><span class="delimiter">'</span></span>,
                [user.email] <span class="keyword">as</span> <span class="predefined-type">Object</span><span class="type">[]</span>,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">User saved with </span><span class="inline"><span class="inline-delimiter">${</span>user?.email<span class="inline-delimiter">}</span></span><span class="content"> email address</span><span class="delimiter">&quot;</span></span>,
                request.locale)
        redirect <span class="key">action</span>: <span class="string"><span class="delimiter">'</span><span class="content">index</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>


<h2 id="testing">2.7 Testing</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/testing.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a functional test which verifies that a <code>Notification</code> instance is created, due to the event triggering, when a <code>User</code> is created.</p>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/demo/RegisterControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">geb.spock.GebSpec</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.Rollback</span>
<span class="keyword">import</span> <span class="include">grails.testing.mixin.integration.Integration</span>
<span class="keyword">import</span> <span class="include">spock.lang.IgnoreIf</span>

<span class="annotation">@IgnoreIf</span>({ !<span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">'</span><span class="content">geb.env</span><span class="delimiter">'</span></span>) })
<span class="annotation">@Integration</span>
<span class="type">class</span> <span class="class">RegisterControllerSpec</span> <span class="directive">extends</span> GebSpec {

    NotificationService notificationService

    UserService userService

    <span class="annotation">@Rollback</span>
    <span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">If you signup a User, an Event triggers which causes a Notification to be saved</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        go <span class="string"><span class="delimiter">'</span><span class="content">/signup</span><span class="delimiter">'</span></span>
        <span class="error">$</span>(<span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>) &lt;&lt; <span class="string"><span class="delimiter">'</span><span class="content">Sergio</span><span class="delimiter">'</span></span>
        <span class="error">$</span>(<span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>) &lt;&lt; <span class="string"><span class="delimiter">'</span><span class="content">del Amo</span><span class="delimiter">'</span></span>
        <span class="error">$</span>(<span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span>) &lt;&lt; <span class="string"><span class="delimiter">'</span><span class="content">delamos@email.com</span><span class="delimiter">'</span></span>
        <span class="error">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#submit</span><span class="delimiter">'</span></span>).click()

        <span class="key">then</span>:
        userService.count() == old(userService.count()) + <span class="integer">1</span>
        notificationService.count() == old(notificationService.count()) + <span class="integer">1</span>

        <span class="key">cleanup</span>:
        userService.deleteByEmail(<span class="string"><span class="delimiter">'</span><span class="content">delamos@email.com</span><span class="delimiter">'</span></span>)
        notificationService.deleteByEmail(<span class="string"><span class="delimiter">'</span><span class="content">delamos@email.com</span><span class="delimiter">'</span></span>)
    }
}</code></pre>
</div>
</div>


<h1 id="runningTheApp">3 Running the Tests</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-events/edit/master/src/main/docs/guide/runningTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./grailsw
grails&gt; test-app
grails&gt; open test-report</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew check
open build/reports/tests/index.html</code></pre>
</div>
</div>

                                        </div>
                                    </td>
                                    <td id="col2">
                                        <div class="local clearfix">
                                            <div class="local-title" style="text-align: right"><a href="https://travis-ci.org/grails-guides/grails-events"><img src="https://travis-ci.org/grails-guides/grails-events.svg?branch=master" /></a></div>            

                                            <div class="local-title">
                                                <a href="https://github.com/grails-guides/grails-events">
                                                    <svg height="35" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="35" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></a> &nbsp;&nbsp;Get the Code
                                                </div>
                                                <div class="menu">
                                                    <div class="input-group">                        
                                                        <button href="#" onclick="document.getElementById('github-url').value='git@github.com:grails-guides/grails-events.git'" class="codeButton">SSH</button>
                                                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-events.git'" class="codeButton">HTTPS</button>
                                                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-events'" class="codeButton">Subversion</button>
                                                    </div>

                                                    <div class="input-group">                    
                                                        <!-- Target -->
                                                        <input id="github-url" value="git@github.com:grails-guides/grails-events.git" type="text" />

                                                        <!-- Trigger -->
                                                        <button class="clipbtn" type="button" data-clipboard-target="#github-url">

                                                            <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
                                                        </button>       

                                                    </div>
                                                    <div class="input-group">
                                                      <a href="https://github.com/grails-guides/grails-events/archive/master.zip" class="downloadButton">Download ZIP</a>
                                                  </div>
                                              </div>
                                              
                                              <div id="table-of-content">
                                                <h2>Table of Contents</h2>
                                                
                                                <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>1</strong><span>Getting Started</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>1.1</strong><span>What you will need</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#howto"><strong>1.2</strong><span>How to complete the guide</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>2</strong><span>Writing the Application</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#domain"><strong>2.1</strong><span>Domain Classes</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#dataServices"><strong>2.2</strong><span>Data Services</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#urlMapping"><strong>2.3</strong><span>Url Mapping</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#view"><strong>2.4</strong><span>View</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#services"><strong>2.5</strong><span>Services</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#controllers"><strong>2.6</strong><span>Controller</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#testing"><strong>2.7</strong><span>Testing</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:0px"><a href="#runningTheApp"><strong>3</strong><span>Running the Tests</span></a></div>
                                                
                            <div style="clear:both" ></div>
                        </div>
                                            
                    </div>
                </td>
            </tr>
        </table>

        <div id="footer">
            Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
            
        </div>

            <!-- END CONTENT -->
          </div>
        </div>
      </div>
    </div>

<script type="text/javascript">
    new Clipboard('.clipbtn');
</script>
<script type="text/javascript" src="../js/docs.js"></script>
<script type="text/javascript" src="../js/classie.js"></script>        
<script type="text/javascript" src="../js/sidebarEffects.js"></script>
<script type="text/javascript" src="../js/navbar.js"></script> 
<style type="text/css">
    #colset {
        background-color: #f5f5f5;
    }
    .grailsnavbar {
        padding-right: 0;
    }
    #fork-me {
        display: none;
    }
</style>       
    </body>
</html>
