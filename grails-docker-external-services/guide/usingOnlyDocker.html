<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>5 Using only Docker</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/guide.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />            
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Grails Framework Guide 
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/training.html"><strong>1</strong><span>Training</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/gettingStarted.html"><strong>2</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/writing.html"><strong>3</strong><span>Writing the Guide</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/running.html"><strong>4</strong><span>Running the app</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/usingOnlyDocker.html"><strong>5</strong><span>Using only Docker</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/helpWithGrails.html"><strong>6</strong><span>Help with Grails</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/running.html">&lt;&lt; <strong>4</strong><span>Running the app</span></a></div>
                

                
                    <div class="toc-item next-right"><a href="../guide/helpWithGrails.html"><strong>6</strong><span>Help with Grails</span> >></a></div>
                


                

                

<h1 id="usingOnlyDocker">5 Using only Docker</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-docker-external-services/edit/master/src/main/docs/guide/usingOnlyDocker.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>There is another option that does not requires the usage of a Gradle plugin. With this approach we can just use <em>plain Docker</em>
to build a Docker image and start a container.</p>
</div>
<div class="sect1">
<h2 id="_defining_the_docker_file">Defining the Docker file</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create the following <code>Dockerfile</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/docker/Dockerfile</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Dockerfile">FROM postgres:9.6.6 <i class="conum" data-value="1"></i><b>(1)</b>

VOLUME /var/lib/postgresql/data <i class="conum" data-value="2"></i><b>(2)</b>

COPY [&quot;setup.sh&quot;, &quot;/docker-entrypoint-initdb.d/&quot;] <i class="conum" data-value="3"></i><b>(3)</b>

EXPOSE 5432 <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the same PostgreSQL image and version as before</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a volume to store the data</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Copy a script to the entrypoint directory. Any <code>.sh</code> or <code>.sql</code> file in this directory will be executing when starting the container</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Expose the port</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also create the file <code>setup.sh</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/docker/setup.sh</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">#!/bin/bash
echo &quot;######### CREATING DATABASE ##########&quot;

# Perform all actions as user 'postgres'
export PGUSER=postgres

# Create specific users for the application and also the databases for dev and test
psql &lt;&lt;EOSQL
    <i class="conum" data-value="1"></i><b>(1)</b>
    CREATE DATABASE dev_demo_db;
    CREATE ROLE dev_user WITH LOGIN PASSWORD 'dev_password';
    GRANT ALL PRIVILEGES ON DATABASE dev_demo_db TO dev_user;

    <i class="conum" data-value="2"></i><b>(2)</b>
    CREATE DATABASE test_demo_db;
    CREATE ROLE test_user WITH LOGIN PASSWORD 'test_password';
    GRANT ALL PRIVILEGES ON DATABASE test_demo_db TO test_user;
EOSQL

echo &quot;&quot;
echo &quot;######### DATABASE CREATED ##########&quot;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the database, user and password for development environment</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define another database, user and password for the test environment</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_the_image">Building the image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With those files created, let&#8217;s build the docker image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ docker build -t postgres-custom src/main/docker/</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_start_a_container">Start a container</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To create and start a container for the first time based on the image we have just created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ docker run -d -p 5432:5432 --name demo-postgres postgres-custom</code></pre>
</div>
</div>
<div class="paragraph">
<p>From now on, every time we want to start/stop the container, we only need to execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ docker start demo-postgres

$ docker stop demo-postgres</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Keep in mind that you also need to change <code>application.yml</code> to use the new credentials defined in <code>setup.sh</code> file.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Replace the database development environment configuration with:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">environments</span>:
    <span class="key">development</span>:
        <span class="key">dataSource</span>:
            <span class="key">dialect</span>: <span class="string"><span class="content">org.hibernate.dialect.PostgreSQLDialect</span></span>
            <span class="key">driverClassName</span>: <span class="string"><span class="content">org.postgresql.Driver</span></span>
            <span class="key">username</span>: <span class="string"><span class="content">dev_user</span></span>
            <span class="key">password</span>: <span class="string"><span class="content">dev_password</span></span>
            <span class="key">dbCreate</span>: <span class="string"><span class="content">update</span></span>
            <span class="key">url</span>: <span class="string"><span class="content">jdbc:postgresql://localhost:5432/dev_demo_db</span></span></code></pre>
</div>
</div>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/running.html">&lt;&lt; <strong>4</strong><span>Running the app</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/helpWithGrails.html"><strong>6</strong><span>Help with Grails</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title" style="text-align: right"><a href="https://travis-ci.org/grails-guides/grails-docker-external-services"><img src="https://travis-ci.org/grails-guides/grails-docker-external-services.svg?branch=master" /></a></div>            
                 <div class="local-title">
                    <a href="https://github.com/grails-guides/grails-docker-external-services">
                    <svg height="35" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="35" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></a> &nbsp;&nbsp;Get the Code
                </div>
                <div class="menu">
                    <div class="input-group">                        
                        <button href="#" onclick="document.getElementById('github-url').value='git@github.com:grails-guides/grails-docker-external-services.git'" class="codeButton">SSH</button>
                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-docker-external-services.git'" class="codeButton">HTTPS</button>
                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-docker-external-services'" class="codeButton">Subversion</button>
                    </div>
       
                    <div class="input-group">                    
                        <!-- Target -->
                        <input id="github-url" value="git@github.com:grails-guides/grails-docker-external-services.git" type="text" />

                        <!-- Trigger -->
                        <button class="clipbtn" type="button" data-clipboard-target="#github-url">

                            <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
                        </button>       

                    </div>
                    <div class="input-group">
                      <a href="https://github.com/grails-guides/grails-docker-external-services/archive/master.zip" class="downloadButton">Download ZIP</a>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
