<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>2.2.2 SendGrid null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Send Emails from Micronaut
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/writingTheApp.html"><strong>2</strong><span>Writing the App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/testingTheApp.html"><strong>3</strong><span>Testing the Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/help.html"><strong>4</strong><span>Help with Micronaut</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/testingTheApp.html"><strong>3</strong><span>Testing the Application</span> >></a></div>
                


                <div class="project">
                    <h1>2.2.2 SendGrid</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                

                

<h2 id="sendGridService">2.2.2 SendGrid</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-kotlin/edit/master/src/main/docs/guide/writingTheApp/services/sendGridService.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><a href="http://sendgrid.com">SendGrid</a> is a transactional email service.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>SendGrid is responsible for sending billions of emails for some of the best and brightest companies in the world.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Add a dependency to SendGrid SDK:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">implementation 'com.sendgrid:sendgrid-java:4.1.2'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a service which encapsulates the integration with SendGrid. The bean will not be loaded if the
system properties (<code>sendgrid.apikey</code>, <code>sendgrid.fromemail</code>) or environment variables (<code>SENDGRID_APIKEY</code>, <code>SENDGRID_FROM_EMAIL</code>) are not present.</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/SendGridEmailCondition.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.micronaut.context.condition.Condition
import io.micronaut.context.condition.ConditionContext
import io.micronaut.core.util.StringUtils

class SendGridEmailCondition : Condition {
    override fun matches(context: ConditionContext&lt;*&gt;?): Boolean {
        return envOrSysPropNotBlankAndNotNull("SENDGRID_APIKEY", "sendgrid.apikey")
                &amp;&amp; envOrSysPropNotBlankAndNotNull("SENDGRID_FROM_EMAIL", "sendgrid.fromemail")
    }

    private fun envOrSysPropNotBlankAndNotNull(env: String?, prop: String?): Boolean {
        return StringUtils.isNotEmpty(System.getProperty(prop)) || StringUtils.isNotEmpty(System.getenv(env))
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a test:</p>
</div>
<div class="listingblock">
<div class="title">src/test/kotlin/example/micronaut/SendGridEmailConditionSpec.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.micronaut.context.ApplicationContext
import io.micronaut.context.exceptions.NoSuchBeanException
import org.spekframework.spek2.Spek
import org.spekframework.spek2.style.specification.describe
import kotlin.test.assertFailsWith

class SendGridEmailConditionSpec : Spek({

    describe("SendGridEmailService loaded if condition") {
        val applicationContext = ApplicationContext.run("test")
        it("Verify SendGridEmailService is NOT loaded if system properties or environment properties are not set") {
            assertFailsWith&lt;NoSuchBeanException&gt; {
                applicationContext.getBean(SendGridEmailService::class.java)
            }
        }
        afterGroup {
            applicationContext.close()
        }
    }
})</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/SendGridEmailService.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import com.sendgrid.Content
import com.sendgrid.Mail
import com.sendgrid.Method
import com.sendgrid.Personalization
import com.sendgrid.Request
import com.sendgrid.SendGrid
import io.micronaut.context.annotation.Requires
import io.micronaut.context.annotation.Value
import org.slf4j.LoggerFactory
import javax.inject.Singleton
import java.io.IOException

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
@Requires(condition = SendGridEmailCondition::class) <i class="conum" data-value="2"></i><b>(2)</b>
class SendGridEmailService(@Value("\${SENDGRID_APIKEY:none}") apiKeyEnv: String,  <i class="conum" data-value="3"></i><b>(3)</b>
                                    @Value("\${SENDGRID_FROM_EMAIL:none}") fromEmailEnv: String,
                                    @Value("\${sendgrid.apikey:none}") apiKeyProp: String,
                                    @Value("\${sendgrid.fromemail:none}") fromEmailProp: String) : EmailService {
    protected val apiKey: String
    protected val fromEmail: String

    init {
        this.apiKey = if (apiKeyEnv != "none") apiKeyEnv else apiKeyProp
        this.fromEmail = if (fromEmailEnv != "none") fromEmailEnv else fromEmailProp
    }

    protected fun contentOfEmail(email: Email): Content? {
        if (email.textBody() != null) {
            return Content("text/plain", email.textBody())
        }
        return if (email.htmlBody() != null) {
            Content("text/html", email.htmlBody())
        } else null
    }

    override fun send(email: Email) {

        val personalization = Personalization()
        personalization.subject = email.subject()

        val to = com.sendgrid.Email(email.recipient())
        personalization.addTo(to)

        if (email.cc() != null) {
            for (cc in email.cc()!!) {
                val ccEmail = com.sendgrid.Email()
                ccEmail.email = cc
                personalization.addCc(ccEmail)
            }
        }

        if (email.bcc() != null) {
            for (bcc in email.bcc()!!) {
                val bccEmail = com.sendgrid.Email()
                bccEmail.email = bcc
                personalization.addBcc(bccEmail)
            }
        }

        val mail = Mail()
        val from = com.sendgrid.Email()
        from.email = fromEmail
        mail.from = from
        mail.addPersonalization(personalization)
        val content = contentOfEmail(email)
        mail.addContent(content!!)

        val sg = SendGrid(apiKey)
        val request = Request()
        try {
            request.method = Method.POST
            request.endpoint = "mail/send"
            request.body = mail.build()

            val response = sg.api(request)
            if (LOG.isInfoEnabled) {
                LOG.info("Status Code: {}", response.statusCode.toString())
                LOG.info("Body: {}", response.body)
                for (k in response.headers.keys) {
                    val v = response.headers[k]
                    LOG.info("Response Header {} =&gt; {}", k, v)
                }
            }


        } catch (ex: IOException) {
            if (LOG.isErrorEnabled) {
                LOG.error(ex.message)
            }
        }
    }

    companion object {
        private val LOG = LoggerFactory.getLogger(SendGridEmailService::class.java)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>javax.inject.Singleton</code> to designate a class a a singleton</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Bean will not loaded unless condition is met.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Values will be resolved from system properties.</td>
</tr>
</table>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/testingTheApp.html"><strong>3</strong><span>Testing the Application</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
