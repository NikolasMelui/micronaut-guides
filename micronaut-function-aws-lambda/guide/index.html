<!DOCTYPE html>
<html>
<head>
    <meta name='google-site-verification' content='REYQ1_I6HGowAE7LOLVqfQbnKaB4IfFpMlGzMbJj55Q' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='../img/micronaut-favicon.ico' />
    <meta charset='UTF-8' />
    <title>Micronaut Functions deployed in AWS Lambda | Micronaut Guides | Micronaut Framework</title>
    <meta name='description' content='Micronaut Functions deployed in AWS Lambda. Learn how to write a function with Micronaut and deploy it to AWS Lambda.' />
    <link rel="stylesheet" href="../css/highlight/agate.css">
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel='stylesheet' href='../css/main.css' />
    <link rel='stylesheet' href='../css/screen.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js'></script>
</head>
<body class='guide'>
<div id="navigation">
    <div class="navTitle">
        <span id="logo"><a href="http://micronaut.io" title="Go to Micronaut Website"><img src="../img/micronaut-logo-white.svg" alt="Micronaut"/></a></span>
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <a href="http://guides.micronaut.io">Micronaut Guides</a>
                <span> &rarr; </span>
                <a href="http://guides.micronaut.io/micronaut-microservices-services-discover-consul/guide/index.html">Micronaut Functions deployed in AWS Lambda</a>
            </li>
        </ul>

    </div>
</div>

<div class='fullwidth'><article class="guide">
    <aside>
        <a href="https://travis-ci.org/micronaut-guides/micronaut-microservices-services-discover-consul"><img src="https://travis-ci.org/micronaut-guides/micronaut-microservices-services-discover-consul.svg?branch=master"></a>

        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul&quot;"><img height="15" src="../img/github_white.svg" alt="Github"/><span>&nbsp;Get the Code</span></button>


        <ul class="githublinks">
            <li><button type="button" class="btn btn-default" href="#" onclick="document.getElementById('github-url').value='git@github.com:micronaut-guides/micronaut-microservices-services-discover-consul.git'" class="codeButton">SSH</button></li>
            <li><button type="button" class="btn btn-default" onclick="document.getElementById('github-url').value='https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul.git'" class="codeButton">HTTPS</button></li>
        </ul>
        <div class="input-group">
            <!-- Target -->
            <input id="github-url" value="git@github.com:micronaut-guides/micronaut-microservices-services-discover-consul.git" type="text" />
            <!-- Trigger -->
            <button type="button" class="clippy btn btn-default" type="button" data-clipboard-target="#github-url">
                <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
            </button>
        </div>
        <script>var clipboard = new Clipboard('.clippy');</script>
        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/archive/master.zip&quot;">Download ZIP</button>
        
        <div id="table-of-content">
            <h3>Table of Contents</h3>
            
            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>1</strong><span>Getting Started</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>1.1</strong><span>What you will need</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#solution"><strong>1.2</strong><span>Solution</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheLambda"><strong>2</strong><span>Writing the Function</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#functionpojos"><strong>2.1</strong><span>POJOs</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#soap"><strong>2.2</strong><span>SOAP VAT Validation</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#function"><strong>2.3</strong><span>Function</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#functiontests"><strong>2.4</strong><span>Function Tests</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#awslambda"><strong>3</strong><span>Deploy to AWS Lambda</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>4</strong><span>Writing the App</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#pojos"><strong>4.1</strong><span>POJOs</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#functionclient"><strong>4.2</strong><span>Call the Function</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#controller"><strong>4.3</strong><span>Controller</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#tests"><strong>4.4</strong><span>Tests</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#runningTheApp"><strong>5</strong><span>Running the app</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#nextSteps"><strong>6</strong><span>Next Steps</span></a></div>
            
            <div style="clear:both" ></div>
        </div>
        
    </aside>
    <header>
        <h1>Micronaut Functions deployed in AWS Lambda</h1>
        <p>Learn how to write a function with Micronaut and deploy it to AWS Lambda.</p>
        <p><strong>Authors:</strong> Sergio del Amo</p>
        <p><strong>Micronaut Version:</strong> 1.0.0.M4</p>
    </header>
    

<h1 id="gettingStarted">1 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Lets describe the microservices you are going to build through the tutorial.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>vies-vat-validator</code> - A Function which you will build with Micronaut and deploy to <a href="https://aws.amazon.com/lambda/">AWS Lambda</a>.</p>
</li>
<li>
<p><code>invoice</code> - A microservice which  exposes an endpoint to check the Value Added Tax (VAT) which should apply to an invoice. It consumes the <code>vies-vat-validator</code> function to ensure the VAT number is valid.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The next diagramm illustrates the flow:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/microservices-and-lambda.svg" alt="microservices and lambda">
</div>
</div>
<div class="paragraph">
<p>If you are using Java or Kotlin and IntelliJ IDEA make sure you have enabled annotation processing.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/annotationprocessorsintellij.png" alt="annotationprocessorsintellij">
</div>
</div>


<h2 id="requirements">1.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>


<h2 id="solution">1.2 Solution</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/solution.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We recommend you to follow the instructions in the next sections and create the app step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository: <code>git clone <a href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul.git" class="bare">https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, <code>cd</code> into the <code>complete</code> folder which you will find in the root project of the downloaded/cloned project.</p>
</div>


<h1 id="writingTheLambda">2 Writing the Function</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheLambda.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create the function:</p>
</div>
<div class="paragraph">
<p><code>mn create-function example.micronaut.vies-vat-validator</code></p>
</div>


<h2 id="functionpojos">2.1 POJOs</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheLambda/functionpojos.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a POJO to encapsulate the validation request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
  "memberStateCode": "es",
  "vatNumber": "B86412491"
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/main/java/example/micronaut/VatValidationRequest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import java.io.Serializable;

public class VatValidationRequest implements Serializable {
    private String memberStateCode;
    private String vatNumber;

    public VatValidationRequest() {
    }

    public VatValidationRequest(String memberStateCode, String vatNumber) {
        this.memberStateCode = memberStateCode;
        this.vatNumber = vatNumber;
    }

    public String getMemberStateCode() {
        return memberStateCode;
    }

    public void setMemberStateCode(String memberStateCode) {
        this.memberStateCode = memberStateCode;
    }

    public String getVatNumber() {
        return vatNumber;
    }

    public void setVatNumber(String vatNumber) {
        this.vatNumber = vatNumber;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And another POJO to encapsulate the expected response. Note: we add a <code>Boolean valid</code> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
  "memberStateCode": "es",
  "vatNumber": "B86412491"
  "valid": true
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/main/java/example/micronaut/VatValidation.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import java.io.Serializable;
import java.util.Objects;

public class VatValidation extends VatValidationRequest implements Serializable {
    private Boolean valid;

    public VatValidation() {

    }

    public VatValidation(String memberStateCode, String vatNumber, Boolean valid) {
        super(memberStateCode, vatNumber);
        this.valid = valid;
    }

    public Boolean getValid() {
        return valid;
    }

    public void setValid(Boolean valid) {
        this.valid = valid;
    }

    public Boolean isValid() {
        return valid;
    }
}</code></pre>
</div>
</div>


<h2 id="soap">2.2 SOAP VAT Validation</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheLambda/soap.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>VIES (<a href="http://ec.europa.eu/taxation_customs/vies/faq.html">VAT Information Exchange System</a>) is an electronic mean of validating VAT-identification numbers of economic operators registered in the European Union for cross border transactions on goods or services.</p>
</div>
<div class="paragraph">
<p>For example, if you create an e-commerce Web application in the European union you would need to check the validity of the purchaser&#8217;s
VAT Number in order to create a proper invoice.</p>
</div>
<div class="paragraph">
<p>To automate the validation checks, the EU does not offer a REST endpoint but a SOAP service. Its WSDL file can be obtained <a href="http://ec.europa.eu/taxation_customs/vies/checkVatService.wsdl">here</a>.</p>
</div>
<div class="paragraph">
<p><strong>SOAP</strong> (originally Simple Object Access Protocol) is a protocol specification for exchanging structured information in the implementation of web services in computer networks. Its purpose is to induce extensibility, neutrality and independence</p>
</div>
<div class="paragraph">
<p>Create <code>VatService</code> to do a SOAP request to validate the VAT Number.</p>
</div>
<div class="paragraph">
<p>To consume the SOAP service we could have use a SOAP library. However, the use case is so simple we are going to use the Micronaut HTTP Client and build
the SOAP envelope manually.</p>
</div>
<div class="paragraph">
<p>Add <code>http-client</code> dependency to <code>build.gradle</code></p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">    compile "io.micronaut:http-client"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a <code>VatService</code> which consumes the SOAP Service:</p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/main/java/example/micronaut/VatService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.HttpRequest;
import io.micronaut.http.client.Client;
import io.micronaut.http.client.RxHttpClient;
import io.reactivex.Flowable;

import javax.inject.Singleton;
import java.util.concurrent.Future;

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
public class VatService {
    private static final String SERVER = "http://ec.europa.eu";
    private static final String PATH = "/taxation_customs/vies/services/checkVatService";
    private static final String VALID_XML_OPEN_TAG = "&lt;valid&gt;";
    private static final String VALID_XML_CLOSE_TAG = "&lt;/valid&gt;";

    protected final RxHttpClient client;

    public VatService(@Client("http://ec.europa.eu") RxHttpClient client) { <i class="conum" data-value="2"></i><b>(2)</b>
        this.client = client;
    }

    public Future&lt;Boolean&gt; validateVat(String memberStateCode, String vatNumber) {
        String soapEnvelope = soapEnvelope(memberStateCode, vatNumber);
        HttpRequest request = HttpRequest.POST(SERVER+PATH, soapEnvelope)  <i class="conum" data-value="3"></i><b>(3)</b>
                .contentType("application/soap+xml");

        Flowable&lt;String&gt; response = client.retrieve(request);
        return response.map(this::parseResponseToBoolean).toFuture();
    }

    private Boolean parseResponseToBoolean(String response) {
        if (!response.contains(VALID_XML_OPEN_TAG) || !response.contains(VALID_XML_CLOSE_TAG)) {
            return false;
        }
        int beginIndex = response.indexOf(VALID_XML_OPEN_TAG) + VALID_XML_OPEN_TAG.length();
        String validResponse = response.substring(beginIndex, response.indexOf(VALID_XML_CLOSE_TAG));
        return Boolean.valueOf(validResponse);
    }

    private String soapEnvelope(String memberStateCode, String vatNumber) {
        StringBuilder sb = new StringBuilder();
        sb.append("&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;");
        sb.append("&lt;soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"&gt;");
        sb.append("&lt;soapenv:Header/&gt;");
        sb.append("&lt;soapenv:Body xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"&gt;");
        sb.append("&lt;urn:checkVat xmlns:urn=\"urn:ec.europa.eu:taxud:vies:services:checkVat:types\"&gt;");
        sb.append("&lt;urn:countryCode&gt;");
        sb.append(memberStateCode);
        sb.append("&lt;/urn:countryCode&gt;");
        sb.append("&lt;urn:vatNumber&gt;");
        sb.append(vatNumber);
        sb.append("&lt;/urn:vatNumber&gt;");
        sb.append("&lt;/urn:checkVat&gt;");
        sb.append("&lt;/soapenv:Body&gt;");
        sb.append("&lt;/soapenv:Envelope&gt;");
        return sb.toString();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>javax.inject.Singleton</code> to designate a class a a singleton</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Constructor Injection of Micronaut RxClient</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define a POST Request.</td>
</tr>
</table>
</div>


<h2 id="function">2.3 Function</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheLambda/function.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Edit <code>ViesVatValidatorFunction</code></p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/main/java/example/micronaut/ViesVatValidatorFunction.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.function.FunctionBean;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.concurrent.ExecutionException;
import java.util.function.Function;

@FunctionBean("vies-vat-validator") <i class="conum" data-value="1"></i><b>(1)</b>
public class ViesVatValidatorFunction
        implements Function&lt;VatValidationRequest, VatValidation&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
    private static final Logger LOG = LoggerFactory.getLogger(ViesVatValidatorFunction.class); <i class="conum" data-value="3"></i><b>(3)</b>

    private final VatService vatService;

    public ViesVatValidatorFunction(VatService vatService) { <i class="conum" data-value="4"></i><b>(4)</b>
        this.vatService = vatService;
    }

    @Override
    public VatValidation apply(VatValidationRequest request) {
        final String memberStateCode = request.getMemberStateCode();
        final String vatNumber = request.getVatNumber();
        if (LOG.isDebugEnabled()) {
            LOG.debug("validate country: {} vat number: {}", memberStateCode, vatNumber);
        }
        Boolean valid = false;
        try {
            valid = vatService.validateVat(memberStateCode, vatNumber).get();

        } catch (InterruptedException | ExecutionException e) {

        }
        return new VatValidation(memberStateCode, vatNumber, valid);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@FunctionBean</code>. <code>vies-vat-validator</code> is an optional ID of the function which may or may not be used depending on the target platform.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We implement <code>java.util.function.Function</code>. That it is the easiest way to have a parameter with an incoming JSON Payload
and JSON Payload response.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure a logger for the function. If you use AWS Lambda, you will be able to see this logs in CloudWatch Logs.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Inject via constructor <code>VatService</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Modify <code>logback.xml</code> to set <code>DEBUG</code> level for package <code>example.micronaut</code>.</p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/main/resources/logback.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">&lt;configuration&gt;

    &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;!-- encoders are assigned the type
             ch.qos.logback.classic.encoder.PatternLayoutEncoder by default --&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;root level="info"&gt;
        &lt;appender-ref ref="STDOUT" /&gt;
    &lt;/root&gt;
    &lt;logger name="example.micronaut" level="DEBUG"/&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>


<h2 id="functiontests">2.4 Function Tests</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheLambda/functiontests.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><code>build.gradle</code> already contains these dependencies:</p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">    testRuntime "io.micronaut:http-server-netty"
    testRuntime "io.micronaut:function-web"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because of that, testing your functions is really easy.</p>
</div>
<div class="paragraph">
<p>First modify <code>ViesVatValidatorClient</code> interface to match to the method signature forced by <code>Function&lt;VatValidationRequest, VatValidation&gt;</code>.</p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/test/java/example/micronaut/ViesVatValidatorClient.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.function.client.FunctionClient;
import io.reactivex.Single;

import javax.inject.Named;

@FunctionClient
public interface ViesVatValidatorClient {

    @Named("vies-vat-validator")
    VatValidation apply(VatValidationRequest request);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can start up the Micronaut application and access your function via the client interface in your test.</p>
</div>
<div class="paragraph">
<p>Modify <code>ViesVatValidatorFunctionTest.java</code>:</p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/test/java/example/micronaut/ViesVatValidatorFunctionTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.context.ApplicationContext;
import io.micronaut.runtime.server.EmbeddedServer;
import org.junit.Test;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertTrue;

public class ViesVatValidatorFunctionTest {

    @Test
    public void testViesVatValidatorFunction() throws Exception {
        EmbeddedServer server = ApplicationContext.run(EmbeddedServer.class);

        ViesVatValidatorClient client = server.getApplicationContext().getBean(ViesVatValidatorClient.class);

        assertTrue(client.apply(new VatValidationRequest("es", "B99286353")).isValid());
        assertTrue(client.apply(new VatValidationRequest("es", "B19280031")).isValid());
        assertFalse(client.apply(new VatValidationRequest("es", "XXXXXXXXX")).isValid());

        server.stop();
    }
}</code></pre>
</div>
</div>


<h1 id="awslambda">3 Deploy to AWS Lambda</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/awslambda.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Deploy your Micronaut function to <a href="https://aws.amazon.com/lambda/">AWS Lambda</a>.</p>
</div>
<div class="paragraph">
<p>First, create a Function. I select Paris as the region.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/step1.png" alt="step1">
</div>
</div>
<div class="paragraph">
<p>Select Java 8 runtime. Name: <code>vies-vat-validator</code> and <code>create a new role form template(s)</code>. I give the role name
<code>lambda_basic_execution</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/step2.png" alt="step2">
</div>
</div>
<div class="paragraph">
<p>Configure tests events:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/step3.png" alt="step3">
</div>
</div>
<div class="paragraph">
<p>Create a payload with valid data:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/step4.png" alt="step4">
</div>
</div>
<div class="paragraph">
<p>Generate a jar file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>`vies-vat-validator $ ./gradlew shadowJar`</pre>
</div>
</div>
<div class="paragraph">
<p>The file is just 12MB ;-)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ du -h build/libs/complete/vies-vat-validator-0.1-all.jar
 12M    build/libs/complete/vies-vat-validator-0.1-all.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Upload the JAR as illustrated here:</p>
</div>
<div class="paragraph">
<p>Enter as <code>Handler</code> value <code>io.micronaut.function.aws.MicronautRequestStreamHandler</code>.</p>
</div>
<div class="paragraph">
<p>I have allocated just 256Mb and a timeout of 25s.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/step5.png" alt="step5">
</div>
</div>


<h1 id="writingTheApp">4 Writing the App</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Now, it is time to consume the AWS Lambda function from another micronaut Microservice:</p>
</div>
<div class="paragraph">
<p>Create the microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">mn create-app example.micronaut.invoice</code></pre>
</div>
</div>


<h2 id="pojos">4.1 POJOs</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheApp/pojos.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We expect to get an incoming JSON payload such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
"vatNumber": "B86412491",
"countryCode": "es",
"lines": [
    {
        "count": 2,
        "productId": "1491950358",
        "price": 19.99
    },
    {
        "count": 1,
        "productId": "1680502395",
        "price": 15
    },
]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We create two POJOs to map it.</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/java/example/micronaut/Invoice.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import java.util.List;
import javax.validation.constraints.NotBlank;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Objects;

public class Invoice {

    @NotNull
    @NotBlank
    private String vatNumber;

    @NotNull
    @NotBlank
    private String countryCode;

    @NotEmpty
    private List&lt;InvoiceLine&gt; lines;

    public Invoice() {

    }

    public Invoice(@NotNull @NotBlank String vatNumber,
                   @NotNull @NotBlank String countryCode,
                   @NotEmpty List&lt;InvoiceLine&gt; lines) {
        this.vatNumber = vatNumber;
        this.countryCode = countryCode;
        this.lines = lines;
    }

    public String getVatNumber() {
        return vatNumber;
    }

    public void setVatNumber(String vatNumber) {
        this.vatNumber = vatNumber;
    }

    public String getCountryCode() {
        return countryCode;
    }

    public void setCountryCode(String countryCode) {
        this.countryCode = countryCode;
    }

    public List&lt;InvoiceLine&gt; getLines() {
        return lines;
    }

    public void setLines(List&lt;InvoiceLine&gt; lines) {
        this.lines = lines;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        Invoice invoice = (Invoice) o;
        return Objects.equals(vatNumber, invoice.vatNumber) &amp;&amp;
                Objects.equals(countryCode, invoice.countryCode) &amp;&amp;
                Objects.equals(lines, invoice.lines);
    }

    @Override
    public int hashCode() {
        return Objects.hash(vatNumber, countryCode, lines);
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/java/example/micronaut/InvoiceLine.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import javax.validation.constraints.NotBlank;
import javax.validation.constraints.NotNull;
import javax.validation.constraints.Positive;
import java.math.BigDecimal;
import java.util.Objects;

public class InvoiceLine {
    @NotNull
    @NotBlank
    private String productId;

    @Positive
    private Integer count;

    @NotNull
    @Positive
    private BigDecimal price;

    public InvoiceLine() {}

    public InvoiceLine(String productId, Integer count, BigDecimal price) {
        this.productId = productId;
        this.count = count;
        this.price = price;
    }

    public BigDecimal vatPrice(BigDecimal vatPercentage) {
        return getPrice().multiply(BigDecimal.valueOf(getCount()).multiply(vatPercentage));
    }

    public String getProductId() {
        return productId;
    }

    public void setProductId(String productId) {
        this.productId = productId;
    }

    public Integer getCount() {
        return count;
    }

    public void setCount(Integer count) {
        this.count = count;
    }

    public BigDecimal getPrice() {
        return price;
    }

    public void setPrice(BigDecimal price) {
        this.price = price;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        InvoiceLine that = (InvoiceLine) o;
        return Objects.equals(productId, that.productId) &amp;&amp;
                Objects.equals(count, that.count) &amp;&amp;
                Objects.equals(price, that.price);
    }

    @Override
    public int hashCode() {
        return Objects.hash(productId, count, price);
    }
}</code></pre>
</div>
</div>


<h2 id="functionclient">4.2 Call the Function</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheApp/functionclient.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create an interface to abstract the collaboration with the function:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/java/example/micronaut/VatValidator.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.reactivex.Single;

public interface VatValidator {

    Single&lt;VatValidation&gt; validateVat(String memberStateCode, String vatNumber);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create two POJOs which are used by the previous interface:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/java/example/micronaut/VatValidationRequest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import java.io.Serializable;
import java.util.Objects;

public class VatValidationRequest implements Serializable {
    private String memberStateCode;
    private String vatNumber;

    public VatValidationRequest() {
    }

    public VatValidationRequest(String memberStateCode, String vatNumber) {
        this.memberStateCode = memberStateCode;
        this.vatNumber = vatNumber;
    }

    public String getMemberStateCode() {
        return memberStateCode;
    }

    public void setMemberStateCode(String memberStateCode) {
        this.memberStateCode = memberStateCode;
    }

    public String getVatNumber() {
        return vatNumber;
    }

    public void setVatNumber(String vatNumber) {
        this.vatNumber = vatNumber;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/java/example/micronaut/VatValidation.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import java.io.Serializable;
import java.util.Objects;

public class VatValidation extends VatValidationRequest implements Serializable {

    private Boolean valid;

    public VatValidation() {

    }

    public VatValidation(String memberStateCode, String vatNumber, Boolean valid) {
        super(memberStateCode, vatNumber);
        this.valid = valid;
    }

    public Boolean getValid() {
        return valid;
    }

    public void setValid(Boolean valid) {
        this.valid = valid;
    }

    public Boolean isValid() {
        return valid;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify <code>build.gradle</code> to add <code>function-client</code> and <code>com.amazonaws:aws-java-sdk-lambda</code> dependencies:</p>
</div>
<div class="listingblock">
<div class="title">invoice/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">    compile "io.micronaut:function-client"
    runtime 'com.amazonaws:aws-java-sdk-lambda:1.11.285'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also modify <code>src/main/resources/application.yml</code> and the define a function with the same name <code>vies-vat-validator</code> as the one we deployed to AWS Lambda:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">aws:
    lambda:
        functions:
            vat:
                functionName: vies-vat-validator
                qualifer: vat
        region: eu-west-3 # Paris Region</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the next configuration properties which we will use shortly:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">vat:
    percentage: 0.21
    scale: 2
    retry:
        attempts: 5
        delay: 5s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create <code>VatClient</code> to invoke our function:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/java/example/micronaut/VatClient.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.function.client.FunctionClient;
import io.micronaut.retry.annotation.Retryable;
import io.reactivex.Single;

import javax.inject.Named;

@FunctionClient <i class="conum" data-value="1"></i><b>(1)</b>
public interface VatClient extends VatValidator {

    @Override
    @Named("vies-vat-validator") <i class="conum" data-value="2"></i><b>(2)</b>
    @Retryable(attempts = "${vat.retry.attempts:3}", delay = "${vat.retry.delay:1s}") <i class="conum" data-value="3"></i><b>(3)</b>
    Single&lt;VatValidation&gt; validateVat(String memberStateCode, String vatNumber);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The FunctionClient annotation allows applying introduction advise to an interface such that methods defined by the interface become invokers of remote functions configured by the application.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the function name <code>vies-vat-validator</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>AWS Lambda functions may take time to warm up. Thus, failure is something you have to plan for and it is pretty common to want to attempt to retry an operation if it fails.
With <a href="https://docs.micronaut.io/snapshot/guide/index.html#retry">Micronaut Retry</a> you can try again easily.</td>
</tr>
</table>
</div>


<h2 id="controller">4.3 Controller</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheApp/controller.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut’s validation is built on with the standard framework – JSR 380, also known as Bean Validation 2.0.</p>
</div>
<div class="paragraph">
<p>Hibernate Validator is a reference implementation of the validation API.</p>
</div>
<div class="paragraph">
<p>Add the next snippet to <code>build.gradle</code></p>
</div>
<div class="listingblock">
<div class="title">invoice/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">    compile "io.micronaut:validation"
    compile "io.micronaut.configuration:hibernate-validator"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/java/example/micronaut/InvoiceController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.context.annotation.Value;
import io.micronaut.http.annotation.Body;
import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Post;
import io.micronaut.validation.Validated;
import io.reactivex.Single;

import javax.validation.Valid;
import java.math.BigDecimal;

@Validated <i class="conum" data-value="1"></i><b>(1)</b>
@Controller("/invoice") <i class="conum" data-value="2"></i><b>(2)</b>
public class InvoiceController {

    private final BigDecimal vatPercentage;

    private final VatValidator vatValidator;

    private final int scale;

    public InvoiceController(@Value("${vat.percentage}") BigDecimal vatPercentage, <i class="conum" data-value="3"></i><b>(3)</b>
                             @Value("${vat.scale}") int scale,
                             VatValidator vatValidator) { <i class="conum" data-value="4"></i><b>(4)</b>
        this.vatPercentage = vatPercentage;
        this.scale = scale;
        this.vatValidator = vatValidator;
    }

    @Post("/vat") <i class="conum" data-value="5"></i><b>(5)</b>
    Single&lt;Taxes&gt; calculateVat(@Valid @Body Invoice invoice) {  <i class="conum" data-value="6"></i><b>(6)</b>
        return vatValidator.validateVat(invoice.getCountryCode(), invoice.getVatNumber()) <i class="conum" data-value="7"></i><b>(7)</b>
                .map(vatValidation -&gt; {
                        BigDecimal percentage = vatValidation.isValid() ? vatPercentage : new BigDecimal("0");
                    return new Taxes(invoice.getLines().stream()
                            .map(line -&gt; line.vatPrice(percentage))
                            .reduce(BigDecimal.ZERO, BigDecimal::add)
                            .setScale(scale, BigDecimal.ROUND_HALF_EVEN));
                        });
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add <code>@Validated</code> annotation at the class level to any class that requires validation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The class is defined as a controller with the <code>@Controller</code> annotation mapped to the path <code>/invoice</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Constructor injection of a configuration property.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Constructor injection of a bean.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>@Post</code> annotation is used to map the <code>calculateVat</code> method to all requests to <code>/invoice/vat</code> that use an HTTP POST.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Add <code>@Valid</code> to any method parameter which requires validation. Use a POGO supplied as a JSON payload in the request to populate the invoice.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>This invokes the function in AWS Lambda.</td>
</tr>
</table>
</div>


<h2 id="tests">4.4 Tests</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheApp/tests.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We don&#8217;t want the real AWS Lambda function executed in our tests.</p>
</div>
<div class="paragraph">
<p>Thus, create a bean to replace the function in the test phase:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/test/java/example/micronaut/VatValidatorMock.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.context.annotation.Primary;
import io.micronaut.context.annotation.Replaces;
import io.micronaut.context.annotation.Requires;
import io.micronaut.context.env.Environment;
import io.reactivex.Single;

import javax.inject.Singleton;
import java.util.Collections;
import java.util.List;

@Primary // remove when solved https://github.com/micronaut-projects/micronaut-core/issues/524
@Replaces(VatClient.class)
@Requires(env = Environment.TEST)
@Singleton
public class VatValidatorMock implements VatValidator {

    @Override
    public Single&lt;VatValidation&gt; validateVat(String memberStateCode, String vatNumber) {
        List&lt;String&gt; validVatNumbers = Collections.singletonList("B84965375");
        return Single.just(new VatValidation(memberStateCode,
                vatNumber,
                validVatNumbers.contains(vatNumber)));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a JUnit test which verifies the logic:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/test/java/example/micronaut/InvoiceControllerTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.context.ApplicationContext;
import io.micronaut.http.HttpRequest;
import io.micronaut.http.client.RxHttpClient;
import io.micronaut.runtime.server.EmbeddedServer;
import org.junit.AfterClass;
import org.junit.BeforeClass;
import org.junit.Test;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;

public class InvoiceControllerTest {

    private static EmbeddedServer server;
    private static RxHttpClient rxHttpClient;

    @BeforeClass
    public static void setupServer() {
        server = ApplicationContext.run(EmbeddedServer.class); <i class="conum" data-value="1"></i><b>(1)</b>
        rxHttpClient = server
                .getApplicationContext()
                .createBean(RxHttpClient.class, server.getURL()); <i class="conum" data-value="2"></i><b>(2)</b>
    }

    @AfterClass
    public static void stopServer() {
        if (server != null) {
            server.stop();
        }
        if (rxHttpClient != null) {
            rxHttpClient.stop();
        }
    }

    @Test
    public void testBooksController() {

        VatValidator bean = server.getApplicationContext().getBean(VatValidator.class);
        assertTrue(bean instanceof VatValidatorMock); <i class="conum" data-value="3"></i><b>(3)</b>

        List&lt;InvoiceLine&gt; lines = new ArrayList&lt;InvoiceLine&gt;();
        lines.add(new InvoiceLine("1491950358", 2, new BigDecimal(19.99)));
        lines.add(new InvoiceLine("1680502395", 1, new BigDecimal(15)));
        Invoice invoice = new Invoice("B84965375", "es", lines);
        HttpRequest request = HttpRequest.POST("/invoice/vat", invoice);
        Taxes rsp = rxHttpClient.toBlocking().retrieve(request, Taxes.class);
        BigDecimal expected = new BigDecimal("11.55");
        assertEquals(expected, rsp.getVat());


        invoice.setVatNumber("B99999999");
        rsp = rxHttpClient.toBlocking().retrieve(request, Taxes.class);
        expected = new BigDecimal("0.00");
        assertEquals(expected, rsp.getVat());
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To run the application from a unit test you can use the <a href="http://docs.micronaut.io/snapshot/api/io/micronaut/runtime/server/EmbeddedServer.html">EmbeddedServer</a> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Register a <code>RxHttpClient</code> bean in the application context and point it to the embedded server URL. The <code>EmbeddedServer</code> interface provides the URL of the server under test which runs on a random port.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Verify the bean for interface <code>VatValidator</code> is <code>VatValidatorMock</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you are curious about how the 11.55 is calculated.
Given a 21% VAT.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Price</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Line VAT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">19,99</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8,3958</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3,15</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total VAT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11,55</p></td>
</tr>
</tbody>
</table>


<h1 id="runningTheApp">5 Running the app</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/runningTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The easiest way to configure credentials for invoking the function is to define a ~/.aws/credentials` file`.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">[default]
aws_access_key_id=XXXXXXXXXXX
aws_secret_access_key=XXXXX</code></pre>
</div>
</div>
<div class="paragraph">
<p>To run the application use the <code>./gradlew run</code> command which will start the application on a random port.</p>
</div>
<div class="paragraph">
<p>execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">curl -X "POST" "http://localhost:8080/invoice/vat" \
     -H 'Content-Type: application/json' \
     -d $'{
  "countryCode": "es",
  "vatNumber": "B86412491",
  "lines": [
    {
      "count": 2,
      "price": 19.99,
      "productId": "1491950358"
    },
    {
      "count": 1,
      "price": 15,
      "productId": "1680502395"
    }
  ]
}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>and you will get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">{"vat":11.55}</code></pre>
</div>
</div>


<h1 id="nextSteps">6 Next Steps</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/nextSteps.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Read more about <a href="https://docs.micronaut.io/snapshot/guide/index.html#serverlessFunctions">Serverless Functions</a> inside Micronaut.</p>
</div>

</article>
</div>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115754405-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-115754405-1');
</script>
</body>
</html>
