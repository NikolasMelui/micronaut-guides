<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
    <head>
        <title>Grails Multi-datasource</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />
        <link rel="stylesheet" href="../css/guide.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />        
        <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8" />

        <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.13/clipboard.min.js"></script>
    <script type="text/javascript">
function addJsClass(el) {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>

        <link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css" />        
        <link rel="stylesheet" type="text/css" href="../css/navbar.css" />
        <link rel="stylesheet" type="text/css" href="../css/stMenu.css" />      

    </head>

    <body class="body" onload="addJsClass();">

    <a href="https://github.com/grails/grails-core" target="_blank">
      <div id="fork-me">
        <p>Fork me on Github</p>
      </div>
    </a>
    <div id="st-container" class="st-container st-effect-9">
      <nav class="st-menu st-effect-9" id="menu-12">
        <h2 class="icon icon-lab">Socialize</h2>
        <ul>
          <li><a href="http://grails.org/mailing-lists.html" class="icon"><span class="fa fa-envelope"></span> Discuss on the Mailing List</a></li>
          <li><a href="http://slack-signup.grails.org" class="icon"><span class="fa fa-slack"></span> Discuss on Slack</a></li>
          <li><a href="https://twitter.com/grailsframework" class="icon"><span class="fa fa-twitter"></span> Grails on Twitter</a></li>
          <li><a href="http://grails.org/events.html" class="icon"><span class="fa fa-calendar"></span> Events and conferences</a></li>
          <li><a href="https://github.com/grails/grails-core" class="icon"><span class="fa fa-github"></span> Source code on GitHub</a></li>
          <li><a href="http://grails.org/contribute.html#reporting-issues" class="icon"><span class="fa fa-bug"></span> Report issues on Github</a></li>
          <li><a href="http://stackoverflow.com/questions/tagged/grails" class="icon"><span class="fa fa-stack-overflow"></span> Stack Overflow questions</a></li>
        </ul>
      </nav>
      <div class="st-pusher">
        <div class="st-content">
          <div class="st-content">
            <div class="grailsnavbar grailsnavbar-default">
              <div class="grailsnavbar-container">
                <div class="grailsnavbar-header">
                  <a class="grailsnavbar-brand" href="index.html"><i class="fa grails-icon"><img src="../img/grails-cupsonly-logo-white.svg"></i> Grails</a>
                </div>
                <a id="nav-icon" href="javascript:toggleNavIcon();">
                  <span></span>
                  <span></span>
                  <span></span>
                </a>
                <div class="grailsnavbar-collapse collapse">
                  <ul id="grailsnavbar-nav" class="grailsnavbar-nav grailsnavbar-right closemobile">
                    <li><a href="http://grails.org/learn.html">Learn</a></li>
                    <li><a href="http://guides.grails.org">Guides</a></li>
                    <li><a href="http://grails.org/documentation.html">Documentation</a></li>
                    <li><a href="http://grails.org/download.html">Download</a></li>
                    <li><a href="http://plugins.grails.org">Plugins</a></li>
                    <li><a href="http://grails.org/community.html">Community</a></li>
                    <li><a href="http://grails.org/support.html">Support</a></li>
                    <li><a data-effect="st-effect-9" class="st-trigger" href="#">Socialize</a></li>
                    <li><a href="http://grails.org/search.html"><i class="fa fa-search"></i></a></li>
                  </ul>
                </div>
              </div>
            </div>
            <!-- CONTENT -->
<table id="colset" border="0" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td id="col1">
                                        <div id="main" class="corner-all">

                                            <div class="project">
                                                <h1>Grails Multi-datasource</h1>
                                                <p></p>
                                                <p>Learn how to consume and handle transactions to multiple data sources from a Grails application. </p>
                                                <p><strong>Authors:</strong> Sergio del Amo</p>
                                                <p><strong>Grails Version:</strong> 3.3.1</p>

                                            </div>

                                            

<h1 id="training">1 Training</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-multi-datasource/edit/master/src/main/docs/guide/training.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><strong>Grails Training</strong> - Developed and delivered by the folks who created and actively maintain the Grails framework!.</p>
</div>
<div id="ocitraining"></div>
<script type="text/javascript">
var getJSON = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'json';
    xhr.onload = function() {
      var status = xhr.status;
      if (status == 200) {
        callback(null, xhr.response);
      } else {
        callback(status);
      }
    };
    xhr.send();
};
var ociTrainingTrack = 11;
getJSON('http://plugins.grails.org/api/training/'+ ociTrainingTrack, function(err, data) {
  var msg = '';
  if (err != null) {
      msg = 'Something went wrong while retrieving OCI training offerings';

  } else {
      if ( data.length == 0 ) {
         msg = '<p><b>Currenlty, we don\'t have any training offerings available</b></p>.';

      } else {
        msg += '<table>';
        msg += '<thead>';
        msg += '<tr><th>Course</th><th>Date(s)</th><th>Instructor(s)</th><th>Hour(s)</th></tr>';
        msg += '</thead>';
        msg += '<tbody>';
        for ( var i = 0; i < data.length; i++ ) {
            msg += '<tr><td><a href="'+ data[i].enrollmentLink + '">'+ data[i].course + '</a></td><td>'+ data[i].dates + '</td><td>'+ data[i].instructors + '</td><td>'+ data[i].hours + '</td></tr>';
        }
        msg += '</tbody>';
        msg += '</table>';
      }
  }
  var ociTraining = document.getElementById("ocitraining");
  ociTraining.innerHTML = msg;
});
</script>


<h1 id="gettingStarted">2 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-multi-datasource/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In this guide you are going to&#8230;&#8203;</p>
</div>


<h2 id="requirements">2.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-multi-datasource/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.7 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>


<h2 id="howto">2.2 How to complete the guide</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-multi-datasource/edit/master/src/main/docs/guide/howto.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To get started do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/grails-guides/grails-multi-datasource/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository:<br>
<code>git clone <a href="https://github.com/grails-guides/grails-multi-datasource.git" class="bare">https://github.com/grails-guides/grails-multi-datasource.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Grails guides repositories contain two folders:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>initial</code>  Initial project. Often a simple Grails app with additional some code to give you a head-start.</p>
</li>
<li>
<p><code>complete</code> A completed example. It is the result of working through the steps presented by the guide and applying those changes to the <code>initial</code> folder.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To complete the guide, go to the <code>initial</code> folder</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cd</code> into <code>grails-guides/grails-multi-datasource/initial</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and follow the instructions in the next sections.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can go right to the <strong>completed example</strong> if you <code>cd</code> into <code>grails-guides/grails-multi-datasource/complete</code>
</td>
</tr>
</table>
</div>


<h1 id="writingTheApp">3 Writing the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-multi-datasource/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We are writing a Grails Application using the <code>rest-profile</code> which connects to two data sources.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/graph.jpg" alt="graph">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In previous versions of Grails for multiple data sources a best effort transaction chain was used to attempt to manage a transaction across all configured data sources. As of Grails 3.3 this is disabled as it caused confusion since it isn’t a true XA implementation and also impacts performance as for every transaction you have a transaction for each data source bound regardless if that is the actual requirement.
</td>
</tr>
</table>
</div>


<h2 id="configuration">3.1 Configuration</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-multi-datasource/edit/master/src/main/docs/guide/configuration.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Wire-up two data sources in <code>application.yml</code></p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">dataSource</span>:
    <span class="key">pooled</span>: <span class="predefined-constant">true</span>
    <span class="key">jmxExport</span>: <span class="predefined-constant">true</span>
    <span class="key">driverClassName</span>: org.h2.Driver
    <span class="key">username</span>: sa
    <span class="key">password</span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>
<span class="key">environments</span>:
    <span class="key">development</span>:
        <span class="key">dataSource</span>:
            <span class="key">dbCreate</span>: create-drop
            <span class="key">url</span>: <span class="key">jdbc</span>:<span class="key">h2</span>:<span class="key">mem</span>:devDb;MVCC=TRUE;LOCK_TIMEOUT=<span class="integer">10000</span>;DB_CLOSE_ON_EXIT=FALSE
        <span class="key">dataSources</span>:
            <span class="key">books</span>:
                <span class="key">dbCreate</span>: create-drop
                <span class="key">url</span>: <span class="key">jdbc</span>:<span class="key">h2</span>:<span class="key">mem</span>:bookDevDb;MVCC=TRUE;LOCK_TIMEOUT=<span class="integer">10000</span>;DB_CLOSE_ON_EXIT=FALSE
    <span class="key">test</span>:
        <span class="key">dataSource</span>:
            <span class="key">dbCreate</span>: create-drop
            <span class="key">url</span>: <span class="key">jdbc</span>:<span class="key">h2</span>:<span class="key">mem</span>:testDb;MVCC=TRUE;LOCK_TIMEOUT=<span class="integer">10000</span>;DB_CLOSE_ON_EXIT=FALSE
        <span class="key">dataSources</span>:
            <span class="key">books</span>:
                <span class="key">dbCreate</span>: create-drop
                <span class="key">url</span>: <span class="key">jdbc</span>:<span class="key">h2</span>:<span class="key">mem</span>:bookTestDb;MVCC=TRUE;LOCK_TIMEOUT=<span class="integer">10000</span>;DB_CLOSE_ON_EXIT=FALSE</code></pre>
</div>
</div>


<h2 id="domain">3.2 Domain Classes</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-multi-datasource/edit/master/src/main/docs/guide/domain.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a <code>Movie</code> domain class. If we don&#8217;t specify any data source, it gets associated with the <strong>default</strong> data source.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/demo/Movie.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="type">class</span> <span class="class">Movie</span> {
    <span class="predefined-type">String</span> title
    <span class="directive">static</span> hasMany = [<span class="key">keywords</span>: Keyword]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a <code>Book</code> domain class.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/demo/Book.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="type">class</span> <span class="class">Book</span> {
    <span class="predefined-type">String</span> title

    <span class="directive">static</span> hasMany = [<span class="key">keywords</span>: Keyword]

    <span class="directive">static</span> mapping = {
        datasource <span class="string"><span class="delimiter">'</span><span class="content">books</span><span class="delimiter">'</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>Book</code> domain class is associated with the <code>books</code> data source.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a <code>Keyword</code> domain class.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/demo/Keyword.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.core.connections.ConnectionSource</span>

<span class="type">class</span> <span class="class">Keyword</span> {
    <span class="predefined-type">String</span> name

    <span class="directive">static</span> mapping = {
        datasources([ConnectionSource.DEFAULT, <span class="string"><span class="delimiter">'</span><span class="content">books</span><span class="delimiter">'</span></span>]) <i class="conum" data-value="1"></i><b>(1)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>Keyword</code> domain class is associated with to both data sources (dataSource - default one - and  <code>books</code>).</td>
</tr>
</table>
</div>


<h2 id="services">3.3 Services</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-multi-datasource/edit/master/src/main/docs/guide/services.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a <a href="http://gorm.grails.org/latest/hibernate/manual/index.html#dataServices">DataService</a> for <code>Movie</code> domain class.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/MovieDataService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.services.Join</span>
<span class="keyword">import</span> <span class="include">grails.gorm.services.Service</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="annotation">@Service</span>(Movie)
<span class="type">interface</span> MovieDataService {

    <span class="type">void</span> deleteByTitle(<span class="predefined-type">String</span> title)

    <span class="annotation">@Join</span>(<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined-type">List</span>&lt;Movie&gt; findAll()
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>you can specify query joins using the <code>@Join</code> annotation.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you used <code>@ReadOnly</code> instead of <code>@ReadOnly('books')</code> you will get the exception: <code>org.hibernate.HibernateException: No Session found for current thread</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add a regular service:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/MovieService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.transactions.ReadOnly</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.Transactional</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">groovy.util.logging.Slf4j</span>

<span class="annotation">@Slf4j</span>
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">MovieService</span> {

    <span class="annotation">@Transactional</span>
    Movie addMovie(<span class="predefined-type">String</span> title, <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; keywords) {
        Movie movie = <span class="keyword">new</span> Movie(<span class="key">title</span>: title)
        <span class="keyword">if</span> ( keywords ) {
            <span class="keyword">for</span> ( <span class="predefined-type">String</span> keyword : keywords ) {
                movie.addToKeywords(<span class="keyword">new</span> Keyword(<span class="key">name</span>: keyword))
            }
        }
        <span class="keyword">if</span> ( !movie.save() ) {
            log.error <span class="string"><span class="delimiter">'</span><span class="content">Unable to save movie</span><span class="delimiter">'</span></span>
        }
        movie
    }



}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/BookDataService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.services.Join</span>
<span class="keyword">import</span> <span class="include">grails.gorm.services.Service</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.ReadOnly</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.Transactional</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookDataService {

    <span class="annotation">@Join</span>(<span class="string"><span class="delimiter">'</span><span class="content">keywords</span><span class="delimiter">'</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="annotation">@ReadOnly</span>(<span class="string"><span class="delimiter">'</span><span class="content">books</span><span class="delimiter">'</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; findAll()

    <span class="annotation">@Transactional</span>(<span class="string"><span class="delimiter">'</span><span class="content">books</span><span class="delimiter">'</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="type">void</span> deleteByTitle(<span class="predefined-type">String</span> title)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specify the data source name in <code>@Transactional</code> and <code>@ReadOnly</code> annotations.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>you can specify query joins using the <code>@Join</code> annotation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add a regular service:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/BookService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.transactions.Transactional</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">BookService</span> {

    <span class="annotation">@Transactional</span>(<span class="string"><span class="delimiter">'</span><span class="content">books</span><span class="delimiter">'</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined-type">Book</span> addBook(<span class="predefined-type">String</span> title, <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; keywords) {
        <span class="predefined-type">Book</span> book = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="key">title</span>: title)
        <span class="keyword">if</span> ( keywords ) {
            <span class="keyword">for</span> ( <span class="predefined-type">String</span> keyword : keywords ) {
                book.addToKeywords(<span class="keyword">new</span> Keyword(<span class="key">name</span>: keyword))
            }
        }
        <span class="keyword">if</span> ( !book.save() ) {
            log.error <span class="string"><span class="delimiter">'</span><span class="content">Unable to save book</span><span class="delimiter">'</span></span>
        }
        book
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specify the data source name in <code>@Transactional</code> annotation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add a <code>Keyword</code> services which works with multiple data sources.</p>
</div>
<div class="paragraph">
<p>The first data source specified in a domain class is the default when not using an explicit namespace. For <code>Keyword</code>,
the data source <code>ConnectionSource.DEFAULT</code>, the first specified, is used by default.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/services/demo/KeywordService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.gorm.DetachedCriteria</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.ReadOnly</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">KeywordService</span> {

    <span class="annotation">@ReadOnly</span>(<span class="string"><span class="delimiter">'</span><span class="content">books</span><span class="delimiter">'</span></span>)
    <span class="predefined-type">List</span>&lt;Keyword&gt; findAllBooksKeywords() {
        booksQuery().list()
    }

    <span class="annotation">@ReadOnly</span>
    <span class="predefined-type">List</span>&lt;Keyword&gt; findAllDefaultDataSourceKeywords() {
        defaultDataSourceQuery().list()
    }

    <span class="directive">private</span> DetachedCriteria&lt;Keyword&gt; booksQuery() {
        Keyword.where {}.withConnection(<span class="string"><span class="delimiter">'</span><span class="content">books</span><span class="delimiter">'</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span class="directive">private</span> DetachedCriteria&lt;Keyword&gt; defaultDataSourceQuery() {
        Keyword.where {}
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specify the data source name with <code>withConnection</code> for a query.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You could have written the <code>books</code> query with a dynamic finder instead of a <em>where query</em>.</p>
</div>
<div class="paragraph">
<p>Where query: <code>Keyword.where {}.withConnection('books').list()</code></p>
</div>
<div class="paragraph">
<p>Dynamic finder: <code>Keyword.books.findAll()</code></p>
</div>


<h2 id="controllers">3.4 Controllers</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-multi-datasource/edit/master/src/main/docs/guide/controllers.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create <code>BookController</code> and <code>MovieController</code>. Those consume the services previously implemented.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/demo/SaveBookCommand.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.compiler.GrailsCompileStatic</span>
<span class="keyword">import</span> <span class="include">grails.validation.Validateable</span>

<span class="annotation">@GrailsCompileStatic</span>
<span class="type">class</span> <span class="class">SaveBookCommand</span> <span class="directive">implements</span> Validateable {
    <span class="predefined-type">String</span> title
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; keywords

    <span class="directive">static</span> constraints = {
        title <span class="key">nullable</span>: <span class="predefined-constant">false</span>
        keywords <span class="key">nullable</span>: <span class="predefined-constant">true</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/demo/BookController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">BookController</span> {

    <span class="directive">static</span> allowedMethods = [<span class="key">save</span>: <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>, <span class="key">index</span>: <span class="string"><span class="delimiter">'</span><span class="content">GET</span><span class="delimiter">'</span></span>]

    <span class="directive">static</span> responseFormats = [<span class="string"><span class="delimiter">'</span><span class="content">json</span><span class="delimiter">'</span></span>]

    BookService bookService

    KeywordService keywordService

    BookDataService bookDataService

    <span class="keyword">def</span> <span class="function">save</span>(SaveBookCommand cmd) {
        bookService.addBook(cmd.title, cmd.keywords)
        render <span class="key">status</span>: <span class="integer">201</span>
    }

    <span class="keyword">def</span> <span class="function">index</span>() {
        [<span class="key">bookList</span>: bookDataService.findAll()]
    }

    <span class="keyword">def</span> <span class="function">delete</span>(<span class="predefined-type">String</span> title) {
        bookDataService.deleteByTitle(title)
        render <span class="key">status</span>: <span class="integer">204</span>
    }

    <span class="keyword">def</span> <span class="function">keywords</span>() {
        render <span class="key">view</span>: <span class="string"><span class="delimiter">'</span><span class="content">/keyword/index</span><span class="delimiter">'</span></span>,
               <span class="key">model</span>: [<span class="key">keywordList</span>: keywordService.findAllBooksKeywords()]
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/demo/SaveBookCommand.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.compiler.GrailsCompileStatic</span>
<span class="keyword">import</span> <span class="include">grails.validation.Validateable</span>

<span class="annotation">@GrailsCompileStatic</span>
<span class="type">class</span> <span class="class">SaveBookCommand</span> <span class="directive">implements</span> Validateable {
    <span class="predefined-type">String</span> title
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; keywords

    <span class="directive">static</span> constraints = {
        title <span class="key">nullable</span>: <span class="predefined-constant">false</span>
        keywords <span class="key">nullable</span>: <span class="predefined-constant">true</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/controllers/demo/MovieController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">MovieController</span> {

    <span class="directive">static</span> allowedMethods = [<span class="key">save</span>: <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>, <span class="key">index</span>: <span class="string"><span class="delimiter">'</span><span class="content">GET</span><span class="delimiter">'</span></span>]

    <span class="directive">static</span> responseFormats = [<span class="string"><span class="delimiter">'</span><span class="content">json</span><span class="delimiter">'</span></span>]

    MovieService movieService

    MovieDataService movieDataService

    KeywordService keywordService

    <span class="keyword">def</span> <span class="function">save</span>(SaveMovieCommand cmd) {
        movieService.addMovie(cmd.title, cmd.keywords)
        render <span class="key">status</span>: <span class="integer">201</span>
    }

    <span class="keyword">def</span> <span class="function">index</span>() {
        [<span class="key">movieList</span>: movieDataService.findAll()]
    }

    <span class="keyword">def</span> <span class="function">delete</span>(<span class="predefined-type">String</span> title) {
        movieDataService.deleteByTitle(title)
        render <span class="key">status</span>: <span class="integer">204</span>
    }

    <span class="keyword">def</span> <span class="function">keywords</span>() {
        render <span class="key">view</span>: <span class="string"><span class="delimiter">'</span><span class="content">/keyword/index</span><span class="delimiter">'</span></span>,
               <span class="key">model</span>: [<span class="key">keywordList</span>: keywordService.findAllDefaultDataSourceKeywords()]
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>`</p>
</div>


<h2 id="views">3.5 Views</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-multi-datasource/edit/master/src/main/docs/guide/views.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Add multiple <a href="http://views.grails.org/latest/">JSON Views</a> to render the output.</p>
</div>
<div class="listingblock">
<div class="title">grails-app/views/book/_book.gson</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">demo.Book</span>

model {
    <span class="predefined-type">Book</span> book
}

json {
    title book.title
    keywords book.keywords*.name
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/views/book/index.gson</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">demo.Book</span>

model {
    <span class="predefined-type">Iterable</span>&lt;<span class="predefined-type">Book</span>&gt; bookList
}

json tmpl.book(bookList)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/views/movie/_movie.gson</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">demo.Movie</span>

model {
    Movie movie
}

json {
    title movie.title
    keywords movie.keywords*.name
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/views/movie/index.gson</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">demo.Movie</span>

model {
    <span class="predefined-type">Iterable</span>&lt;Movie&gt; movieList
}

json tmpl.movie(movieList)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">grails-app/views/keyword/index.gson</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">demo.Keyword</span>

model {
    <span class="predefined-type">Iterable</span>&lt;Keyword&gt; keywordList
}

json {
    keywords keywordList*.name.unique().sort()
}</code></pre>
</div>
</div>


<h2 id="test">3.6 Functional Test</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-multi-datasource/edit/master/src/main/docs/guide/test.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Add <em>grails-datastore-rest-client</em> as a <em>testCompile</em> dependency:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">testCompile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails:grails-datastore-rest-client</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a functional test which verifies Grails handles Multiple data sources as expected:</p>
</div>
<div class="listingblock">
<div class="title">src/integration-test/groovy/demo/MultipleDataSourceSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> demo

<span class="keyword">import</span> <span class="include">grails.plugins.rest.client.RestBuilder</span>
<span class="keyword">import</span> <span class="include">grails.plugins.rest.client.RestResponse</span>
<span class="keyword">import</span> <span class="include">grails.testing.mixin.integration.Integration</span>
<span class="keyword">import</span> <span class="include">spock.lang.Shared</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@Integration</span>
<span class="type">class</span> <span class="class">MultipleDataSourceSpec</span> <span class="directive">extends</span> Specification {

    <span class="annotation">@Shared</span>
    RestBuilder rest = <span class="keyword">new</span> RestBuilder()

    <span class="directive">private</span> RestResponse saveResource(<span class="predefined-type">String</span> resource, <span class="predefined-type">String</span> itemTitle, <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; itemKeywords) {
        rest.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:</span><span class="inline"><span class="inline-delimiter">${</span>serverPort<span class="inline-delimiter">}</span></span><span class="content">/</span><span class="inline"><span class="inline-delimiter">${</span>resource<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>) {
            accept(<span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>)
            contentType(<span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>)
            json {
                title = itemTitle
                keywords = itemKeywords
            }
        }
    }

    <span class="directive">private</span> RestResponse deleteResource(<span class="predefined-type">String</span> resource, <span class="predefined-type">String</span> itemTitle) {
        rest.delete(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:</span><span class="inline"><span class="inline-delimiter">${</span>serverPort<span class="inline-delimiter">}</span></span><span class="content">/</span><span class="inline"><span class="inline-delimiter">${</span>resource<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>) {
            accept(<span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>)
            contentType(<span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>)
            json {
                title = itemTitle
            }
        }
    }

    <span class="directive">private</span> RestResponse fetchResource(<span class="predefined-type">String</span> resource) {
        rest.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:</span><span class="inline"><span class="inline-delimiter">${</span>serverPort<span class="inline-delimiter">}</span></span><span class="content">/</span><span class="inline"><span class="inline-delimiter">${</span>resource<span class="inline-delimiter">}</span></span><span class="delimiter">&quot;</span></span>) {
            accept(<span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>)
        }
    }

    <span class="directive">private</span> RestResponse resourceKeywords(<span class="predefined-type">String</span> resource) {
        rest.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:</span><span class="inline"><span class="inline-delimiter">${</span>serverPort<span class="inline-delimiter">}</span></span><span class="content">/</span><span class="inline"><span class="inline-delimiter">${</span>resource<span class="inline-delimiter">}</span></span><span class="content">/keywords</span><span class="delimiter">&quot;</span></span>) {
            accept(<span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>)
        }
    }

    <span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Test Multi-Datasource support saving and retrieving books and movies</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        RestResponse resp = saveResource(<span class="string"><span class="delimiter">'</span><span class="content">book</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Change Agent</span><span class="delimiter">'</span></span>, [<span class="string"><span class="delimiter">'</span><span class="content">dna</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">sci-fi</span><span class="delimiter">'</span></span>])

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">201</span>

        <span class="key">when</span>:
        resp = saveResource(<span class="string"><span class="delimiter">'</span><span class="content">book</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Influx</span><span class="delimiter">'</span></span>, [<span class="string"><span class="delimiter">'</span><span class="content">sci-fi</span><span class="delimiter">'</span></span>])

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">201</span>

        <span class="key">when</span>:
        resp = saveResource(<span class="string"><span class="delimiter">'</span><span class="content">book</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Kill Decision</span><span class="delimiter">'</span></span>, [<span class="string"><span class="delimiter">'</span><span class="content">drone</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">sci-fi</span><span class="delimiter">'</span></span>])

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">201</span>

        <span class="key">when</span>:
        resp = saveResource(<span class="string"><span class="delimiter">'</span><span class="content">book</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Freedom (TM)</span><span class="delimiter">'</span></span>, [<span class="string"><span class="delimiter">'</span><span class="content">sci-fi</span><span class="delimiter">'</span></span>])

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">201</span>

        <span class="key">when</span>:
        resp = saveResource(<span class="string"><span class="delimiter">'</span><span class="content">book</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Daemon</span><span class="delimiter">'</span></span>, [<span class="string"><span class="delimiter">'</span><span class="content">sci-fi</span><span class="delimiter">'</span></span>])

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">201</span>

        <span class="key">when</span>:
        resp = saveResource(<span class="string"><span class="delimiter">'</span><span class="content">movie</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Pirates of Silicon Valley</span><span class="delimiter">'</span></span>, [<span class="string"><span class="delimiter">'</span><span class="content">apple</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">microsoft</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">technology</span><span class="delimiter">'</span></span>])

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">201</span>

        <span class="key">when</span>:
        resp = saveResource(<span class="string"><span class="delimiter">'</span><span class="content">movie</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Inception</span><span class="delimiter">'</span></span>, [<span class="string"><span class="delimiter">'</span><span class="content">sci-fi</span><span class="delimiter">'</span></span>])

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">201</span>

        <span class="key">when</span>:
        resp = fetchResource(<span class="string"><span class="delimiter">'</span><span class="content">book</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">200</span>
        resp.json.collect { <span class="local-variable">it</span>.title }.sort() == [<span class="string"><span class="delimiter">'</span><span class="content">Change Agent</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Daemon</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Freedom (TM)</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Influx</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Kill Decision</span><span class="delimiter">'</span></span>]

        <span class="key">when</span>:
        resp = fetchResource(<span class="string"><span class="delimiter">'</span><span class="content">movie</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">200</span>
        resp.json.collect { <span class="local-variable">it</span>.title }.sort() == [<span class="string"><span class="delimiter">'</span><span class="content">Inception</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Pirates of Silicon Valley</span><span class="delimiter">'</span></span>]

        <span class="key">when</span>:
        resp = resourceKeywords(<span class="string"><span class="delimiter">'</span><span class="content">book</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">200</span>
        resp.json.keywords == [<span class="string"><span class="delimiter">'</span><span class="content">dna</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">drone</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">sci-fi</span><span class="delimiter">'</span></span>]

        <span class="key">when</span>:
        resp = resourceKeywords(<span class="string"><span class="delimiter">'</span><span class="content">movie</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">200</span>
        resp.json.keywords == [<span class="string"><span class="delimiter">'</span><span class="content">apple</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">microsoft</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">sci-fi</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">technology</span><span class="delimiter">'</span></span>]


        <span class="key">when</span>:
        resp = deleteResource(<span class="string"><span class="delimiter">'</span><span class="content">book</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Change Agent</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">204</span>

        <span class="key">when</span>:
        resp = deleteResource(<span class="string"><span class="delimiter">'</span><span class="content">book</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Influx</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">204</span>

        <span class="key">when</span>:
        resp = deleteResource(<span class="string"><span class="delimiter">'</span><span class="content">book</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Kill Decision</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">204</span>

        <span class="key">when</span>:
        resp = deleteResource(<span class="string"><span class="delimiter">'</span><span class="content">book</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Freedom (TM)</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">204</span>

        <span class="key">when</span>:
        resp = deleteResource(<span class="string"><span class="delimiter">'</span><span class="content">book</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Daemon</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">204</span>

        <span class="key">when</span>:
        resp = deleteResource(<span class="string"><span class="delimiter">'</span><span class="content">movie</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Pirates of Silicon Valley</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">204</span>

        <span class="key">when</span>:
        resp = deleteResource(<span class="string"><span class="delimiter">'</span><span class="content">movie</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Inception</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        resp.statusCode.value() == <span class="integer">204</span>
    }
}</code></pre>
</div>
</div>


<h1 id="testingTheApp">4 Testing the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-multi-datasource/edit/master/src/main/docs/guide/testingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./grailsw
grails&gt; test-app
grails&gt; open test-report</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew check
open build/reports/tests/index.html</code></pre>
</div>
</div>


<h1 id="helpWithGrails">5 Help with Grails</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-multi-datasource/edit/master/src/main/docs/guide/helpWithGrails.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<h3 style="color: #333;">OCI sponsored the creation of this Guide. OCI offers several <a href="https://objectcomputing.com/products/grails/consulting-support/">Grails services</a>:</h3>

<img src="../img/oci-grails-services.svg"/>

<h3>Free consultation </h3>

<!-- This is the code that is needed to run the form -->

<!--Copy and paste into the document's head or body.-->

<script type="text/javascript">

    /** This section is only needed once per page if manually copying **/
    if (typeof MauticSDKLoaded == 'undefined') {
        var MauticSDKLoaded = true;
        var head            = document.getElementsByTagName('head')[0];
        var script          = document.createElement('script');
        script.type         = 'text/javascript';
        script.src          = 'https://mautic.objectcomputing.com/media/js/mautic-form.js';
        script.onload       = function() {
            MauticSDK.onLoad();
        };
        head.appendChild(script);
        var MauticDomain = 'https://mautic.objectcomputing.com';
        var MauticLang   = {
            'submittingMessage': "Please wait..."
        }
    }
</script>

<!--Copy and paste into the document's body.-->

<style type="text/css" scoped>
    .mauticform_wrapper { max-width: 600px; margin: 10px auto; }
    .mauticform-innerform {}
    .mauticform-post-success {}
    .mauticform-name { font-weight: bold; font-size: 1.5em; margin-bottom: 3px; }
    .mauticform-description { margin-top: 2px; margin-bottom: 10px; }
    .mauticform-error { margin-bottom: 10px; color: red; }
    .mauticform-message { margin-bottom: 10px;color: green; }
    .mauticform-row { display: block; margin-bottom: 20px; }
    .mauticform-label { font-size: 1.1em; display: block; font-weight: bold; margin-bottom: 5px; }
    .mauticform-row.mauticform-required .mauticform-label:after { color: #e32; content: " *"; display: inline; }
    .mauticform-helpmessage { display: block; font-size: 0.9em; margin-bottom: 3px; }
    .mauticform-errormsg { display: block; color: red; margin-top: 2px; }
    .mauticform-selectbox, .mauticform-input, .mauticform-textarea { width: 100%; padding: 0.5em 0.5em; border: 1px solid #CCC; background: #fff; box-shadow: 0px 0px 0px #fff inset; border-radius: 4px; box-sizing: border-box; }
    .mauticform-checkboxgrp-row {}
    .mauticform-checkboxgrp-label { font-weight: normal; }
    .mauticform-checkboxgrp-checkbox {}
    .mauticform-radiogrp-row {}
    .mauticform-radiogrp-label { font-weight: normal; }
    .mauticform-radiogrp-radio {}
    .mauticform-button-wrapper .mauticform-button.btn-default, .mauticform-pagebreak-wrapper .mauticform-pagebreak.btn-default { font-size: 14px; color: #fff;background-color: #feb672 ;border-color: #dddddd; padding: 15px 30px;}
    .mauticform-button-wrapper .mauticform-button, .mauticform-pagebreak-wrapper .mauticform-pagebreak { display: inline-block;margin-bottom: 0;font-weight: 600;text-align: center;vertical-align: middle;cursor: pointer;background-image: none;border: 1px solid transparent;white-space: nowrap;padding: 6px 12px;font-size: 13px;line-height: 1.3856;border-radius: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;}
    .mauticform-button-wrapper .mauticform-button.btn-default[disabled], .mauticform-pagebreak-wrapper .mauticform-pagebreak.btn-default[disabled] { background-color:#feb672; border-color: #dddddd; opacity: 0.75; cursor: not-allowed; font-size: 14px; color: #fff; padding: 15px 30px;}
    .mauticform-pagebreak-wrapper .mauticform-button-wrapper {  display: inline; }
</style>
<div id="mauticform_wrapper_grailsorgconsultationform" class="mauticform_wrapper">
    <form autocomplete="false" role="form" method="post" action="https://mautic.objectcomputing.com/form/submit?formId=3" id="mauticform_grailsorgconsultationform" data-mautic-form="grailsorgconsultationform">

        <div class="mauticform-innerform">

          <div class="mauticform-page-wrapper mauticform-page-1" data-mautic-form-page="1">

            <div id="mauticform_grailsorgconsultationform_first_name"  data-validate="first_name" data-validation-type="text" class="mauticform-row mauticform-text mauticform-field-1 mauticform-required col-lg-6 col-md-6 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_first_name" name="mauticform[first_name]" value="" placeholder="First Name *" class="mauticform-input" type="text" />
                <span class="mauticform-errormsg" style="display: none;">This is required.</span>
            </div>

            <div id="mauticform_grailsorgconsultationform_last_name"  data-validate="last_name" data-validation-type="text" class="mauticform-row mauticform-text mauticform-field-2 mauticform-required col-lg-6 col-md-6 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_last_name" name="mauticform[last_name]" value="" placeholder="Last Name *" class="mauticform-input" type="text" />
                <span class="mauticform-errormsg" style="display: none;">This is required.</span>
            </div>

            <div id="mauticform_grailsorgconsultationform_email"  data-validate="email" data-validation-type="email" class="mauticform-row mauticform-email mauticform-field-3 mauticform-required col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_email" name="mauticform[email]" value="" placeholder="Email *" class="mauticform-input" type="email" />
                <span class="mauticform-errormsg" style="display: none;">This is required.</span>
            </div>

            <div id="mauticform_grailsorgconsultationform_phone"  class="mauticform-row mauticform-tel mauticform-field-4 col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_phone" name="mauticform[phone]" value="" placeholder="Phone" class="mauticform-input" type="tel" />
                <span class="mauticform-errormsg" style="display: none;"></span>
            </div>

            <div id="mauticform_grailsorgconsultationform_company"  class="mauticform-row mauticform-text mauticform-field-5 col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_company" name="mauticform[company]" value="" placeholder="Company" class="mauticform-input" type="text" />
                <span class="mauticform-errormsg" style="display: none;"></span>
            </div>

            <div id="mauticform_grailsorgconsultationform_submit"  class="mauticform-row mauticform-button-wrapper mauticform-field-6" style="">
                <button type="submit" name="mauticform[submit]" id="mauticform_input_grailsorgconsultationform_submit" name="mauticform[submit]" value="" class="mauticform-button btn btn-default" value="1" style="border: none; margin-left: 14px;">SUBMIT</button>
            </div>
            </div>
        </div>

        <input type="hidden" name="mauticform[formId]" id="mauticform_grailsorgconsultationform_id" value="3"/>
        <input type="hidden" name="mauticform[return]" id="mauticform_grailsorgconsultationform_return" value=""/>
        <input type="hidden" name="mauticform[formName]" id="mauticform_grailsorgconsultationform_name" value="grailsorgconsultationform"/>
</form>
</div>

<!--The code below is the message that appears when someone hits submit. Feel free to style this how you see fit for Grails.org. All CSS is handled in the above code.-->

<div class="mauticform-error" id="mauticform_grailsorgconsultationform_error"></div>
<div class="mauticform-message" id="mauticform_grailsorgconsultationform_message"></div>

<h3 style="color: #333;">The <a href="https://objectcomputing.com/products/grails/consulting-support/">OCI Grails Team</a>
includes Grails co-founders, <b>Jeff Scott Brown and Graeme Rocher</b>.
Check our <a href="https://objectcomputing.com/training/catalog/grails/">Grails courses</a> and learn from the engineers who developed,
matured and maintain Grails.</h3>

<img src="../img/ocigrailsteam.png" style="max-width: 748px; width: 100%;" alt="Grails OCI Team">

                                        </div>
                                    </td>
                                    <td id="col2">
                                        <div class="local clearfix">
                                            <div class="local-title" style="text-align: right"><a href="https://travis-ci.org/grails-guides/grails-multi-datasource"><img src="https://travis-ci.org/grails-guides/grails-multi-datasource.svg?branch=master" /></a></div>            

                                            <div class="local-title">
                                                <a href="https://github.com/grails-guides/grails-multi-datasource">
                                                    <svg height="35" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="35" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></a> &nbsp;&nbsp;Get the Code
                                                </div>
                                                <div class="menu">
                                                    <div class="input-group">                        
                                                        <button href="#" onclick="document.getElementById('github-url').value='git@github.com:grails-guides/grails-multi-datasource.git'" class="codeButton">SSH</button>
                                                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-multi-datasource.git'" class="codeButton">HTTPS</button>
                                                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-multi-datasource'" class="codeButton">Subversion</button>
                                                    </div>

                                                    <div class="input-group">                    
                                                        <!-- Target -->
                                                        <input id="github-url" value="git@github.com:grails-guides/grails-multi-datasource.git" type="text" />

                                                        <!-- Trigger -->
                                                        <button class="clipbtn" type="button" data-clipboard-target="#github-url">

                                                            <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
                                                        </button>       

                                                    </div>
                                                    <div class="input-group">
                                                      <a href="https://github.com/grails-guides/grails-multi-datasource/archive/master.zip" class="downloadButton">Download ZIP</a>
                                                  </div>
                                              </div>
                                              
                                              <div id="table-of-content">
                                                <h2>Table of Contents</h2>
                                                
                                                <div class="toc-item" style="margin-left:0px"><a href="#training"><strong>1</strong><span>Training</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>2</strong><span>Getting Started</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>2.1</strong><span>What you will need</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#howto"><strong>2.2</strong><span>How to complete the guide</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>3</strong><span>Writing the Application</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#configuration"><strong>3.1</strong><span>Configuration</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#domain"><strong>3.2</strong><span>Domain Classes</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#services"><strong>3.3</strong><span>Services</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#controllers"><strong>3.4</strong><span>Controllers</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#views"><strong>3.5</strong><span>Views</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:10px"><a href="#test"><strong>3.6</strong><span>Functional Test</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:0px"><a href="#testingTheApp"><strong>4</strong><span>Testing the Application</span></a></div>
                                                
                                                <div class="toc-item" style="margin-left:0px"><a href="#helpWithGrails"><strong>5</strong><span>Help with Grails</span></a></div>
                                                
                            <div style="clear:both" ></div>
                        </div>
                                            
                    </div>
                </td>
            </tr>
        </table>

        <div id="footer">
            Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
            
        </div>

            <!-- END CONTENT -->
          </div>
        </div>
      </div>
    </div>

<script type="text/javascript">
    new Clipboard('.clipbtn');
</script>
<script type="text/javascript" src="../js/docs.js"></script>
<script type="text/javascript" src="../js/classie.js"></script>        
<script type="text/javascript" src="../js/sidebarEffects.js"></script>
<script type="text/javascript" src="../js/navbar.js"></script> 
<style type="text/css">
    #colset {
        background-color: #f5f5f5;
    }
    .grailsnavbar {
        padding-right: 0;
    }
    #fork-me {
        display: none;
    }
</style>       
    </body>
</html>
