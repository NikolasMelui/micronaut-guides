<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>3 Writing the App null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Access a database with JPA and Hibernate
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/usingSnapshotVersion.html"><strong>2</strong><span>Using Snapshot Version</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/writingTheApp.html"><strong>3</strong><span>Writing the App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/runningTheApp.html"><strong>4</strong><span>Running the app</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/usingPostgresql.html"><strong>5</strong><span>Using Postgresql</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/nextSteps.html"><strong>6</strong><span>Next Steps</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/usingSnapshotVersion.html">&lt;&lt; <strong>2</strong><span>Using Snapshot Version</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/runningTheApp.html"><strong>4</strong><span>Running the app</span> >></a></div>
                


                <div class="project">
                    <h1>3 Writing the App</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#datasource"><strong>3.1</strong><span>Configure Data Source and JPA</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#domain"><strong>3.2</strong><span>Domain</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#repository"><strong>3.3</strong><span>Repository Access</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#controller"><strong>3.4</strong><span>Controller</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#tests"><strong>3.5</strong><span>Tests</span></a>
                    </div>
                    
                </div>
                

                

<h1 id="writingTheApp">3 Writing the App</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-data-access-jpa-hibernate/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>If you are using Java or Kotlin and IntelliJ IDEA make sure you have enabled annotation processing.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/annotationprocessorsintellij.png" alt="annotationprocessorsintellij">
</div>
</div>


<h2 id="datasource">3.1 Configure Data Source and JPA</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-data-access-jpa-hibernate/edit/master/src/main/docs/guide/writingTheApp/datasource.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="sect2">
<h3 id="_data_source_configuration">Data Source configuration</h3>
<div class="paragraph">
<p>Add the next snippet to <code>build.gradle</code> to include the necessary dependencies:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">compile "io.micronaut.configuration:hibernate-jpa" <i class="conum" data-value="1"></i><b>(1)</b>
compile "io.micronaut.configuration:jdbc-hikari" <i class="conum" data-value="2"></i><b>(2)</b>
runtime "com.h2database:h2:1.4.196" <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configures Hibernate/JPA EntityManagerFactory beans.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configures SQL DataSource instances using Hikari Connection Pool.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add dependency to in-memory H2 Database.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Define the data source in <code>src/main/resources/application.yml</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">datasources:
    default:
        url: ${JDBC_URL:`jdbc:h2:mem:default;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE`}
        username: ${JDBC_USER:sa}
        password: ${JDBC_PASSWORD:""}
        driverClassName: ${JDBC_DRIVER:org.h2.Driver}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This way of defining the datasource properties means that we can externalize the configuration, for example for
production environment, and also provide a default value for development. If the environment variables are not defined
Micronaut will use the default values.<br>
Also keep in mind that it is necessary to escape the <code>:</code> in the connection url using back ticks.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_jpa_configuration">JPA configuration</h3>
<div class="paragraph">
<p>Add the next snippet to <code>src/main/resources/application.yml</code> to configure JPA:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">jpa:
    default:
        packages-to-scan:
            - 'example.micronaut.domain' <i class="conum" data-value="1"></i><b>(1)</b>
        properties:
            hibernate:
                hbm2ddl:
                    auto: update
                show_sql: true</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Entities are scanned in the package <code>example.micronaut.domain</code>.</td>
</tr>
</table>
</div>
</div>


<h2 id="domain">3.2 Domain</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-data-access-jpa-hibernate/edit/master/src/main/docs/guide/writingTheApp/domain.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create the domain entities:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/domain/Genre.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.domain;

import com.fasterxml.jackson.annotation.JsonIgnore;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.OneToMany;
import javax.persistence.Table;
import javax.validation.constraints.NotNull;
import java.util.HashSet;
import java.util.Set;

@Entity
@Table(name = "genre")
public class Genre {

    public Genre() {}

    public Genre(@NotNull String name) {
        this.name = name;
    }

    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private Long id;

    @NotNull
    @Column(name = "name", nullable = false, unique = true)
    private String name;

    @JsonIgnore
    @OneToMany(mappedBy = "genre")
    private Set&lt;Book&gt; books = new HashSet&lt;&gt;();

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Set&lt;Book&gt; getBooks() {
        return books;
    }

    public void setBooks(Set&lt;Book&gt; books) {
        this.books = books;
    }

    @Override
    public String toString() {
        return "Genre{" +
            "id=" + id +
            ", name='" + name + '\'' +
            '}';
    }
}</code></pre>
</div>
</div>


<h2 id="repository">3.3 Repository Access</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-data-access-jpa-hibernate/edit/master/src/main/docs/guide/writingTheApp/repository.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create an interface to define the operations to access the database:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/genre/GenreRepository.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.genre;

import example.micronaut.PaginationArguments;
import example.micronaut.SortingArguments;
import example.micronaut.domain.Genre;

import java.util.List;
import java.util.Optional;

public interface GenreRepository {

    Optional&lt;Genre&gt; findById(Long id);

    Genre save(String name);

    void deleteById(Long id);

    List&lt;Genre&gt; findAll(PaginationArguments paginationArgs, SortingArguments sortingArgs);

    int update(Long id, String name);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the implementation:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/genre/GenreRepositoryImpl.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.genre;

import example.micronaut.PaginationArguments;
import example.micronaut.SortingArguments;
import example.micronaut.domain.Genre;
import io.micronaut.configuration.hibernate.jpa.scope.CurrentSession;
import io.micronaut.spring.tx.annotation.Transactional;

import javax.inject.Singleton;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
public class GenreRepositoryImpl implements GenreRepository {

    @PersistenceContext
    private EntityManager entityManager;  <i class="conum" data-value="2"></i><b>(2)</b>

    public GenreRepositoryImpl(@CurrentSession EntityManager entityManager) { <i class="conum" data-value="2"></i><b>(2)</b>
        this.entityManager = entityManager;
    }

    @Override
    @Transactional(readOnly = true) <i class="conum" data-value="3"></i><b>(3)</b>
    public Optional&lt;Genre&gt; findById(Long id) {
        return Optional.ofNullable(entityManager.find(Genre.class, id));
    }

    @Override
    @Transactional <i class="conum" data-value="4"></i><b>(4)</b>
    public Genre save(String name) {
        Genre genre = new Genre(name);
        entityManager.persist(genre);
        return genre;
    }

    @Override
    @Transactional
    public void deleteById(Long id) {
        findById(id).ifPresent(genre -&gt; entityManager.remove(genre));
    }

    private final static List&lt;String&gt; VALID_PROPERTY_NAMES = Arrays.asList("id", "name");

    @Transactional(readOnly = true)
    public List&lt;Genre&gt; findAll(PaginationArguments paginationArgs, SortingArguments sortingArgs) {
        String qlString = "SELECT g FROM Genre as g";
        if (sortingArgs != null) {
            if (sortingArgs.getOrder() != null &amp;&amp; VALID_PROPERTY_NAMES.contains(sortingArgs.getSort())) {
                qlString += " ORDER BY g." + sortingArgs.getSort() + " " + sortingArgs.getOrder().toString().toLowerCase();
            }
        }
        TypedQuery query = entityManager.createQuery(qlString, Genre.class);
        if (paginationArgs != null) {
            if (paginationArgs.getMax() != null) {
                query.setMaxResults(paginationArgs.getMax());
            }
            if (paginationArgs.getOffset() != null) {
                query.setFirstResult(paginationArgs.getOffset());
            }
        }
        return query.getResultList();
    }

    @Override
    @Transactional
    public int update(Long id, String name) {
        return entityManager.createQuery("UPDATE Genre g SET name = :name where id = :id")
                .setParameter("name", name)
                .setParameter("id", id)
                .executeUpdate();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>javax.inject.Singleton</code> to designate a class a a singleton.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject easily an <code>EntityManager</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>All database access needs to be wrapped inside a transaccion, we use Micronaut&#8217;s <code>@Transactional</code>. As the method
only reads data from the database, configure it as <code>readOnly = true</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>As this methods modifies the database, define <code>@Transactional</code> without setting <code>readOnly</code>, which, by default is <code>false</code>.</td>
</tr>
</table>
</div>


<h2 id="controller">3.4 Controller</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-data-access-jpa-hibernate/edit/master/src/main/docs/guide/writingTheApp/controller.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut’s validation is built on with the standard framework – JSR 380, also known as Bean Validation 2.0.</p>
</div>
<div class="paragraph">
<p>Hibernate Validator is a reference implementation of the validation API.</p>
</div>
<div class="paragraph">
<p>Add the next snippet to <code>build.gradle</code></p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">    compile "io.micronaut.configuration:hibernate-validator"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create two classes to encapsulate Save and Update operations:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/genre/GenreSaveCommand.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.genre;

import javax.validation.constraints.NotBlank;
import javax.validation.constraints.NotNull;
import java.util.Objects;

public class GenreSaveCommand {

    @NotNull
    @NotBlank
    private String name;

    public GenreSaveCommand() {}

    public GenreSaveCommand(String name) {
        this.name = name;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        GenreSaveCommand that = (GenreSaveCommand) o;
        return Objects.equals(name, that.name);
    }

    @Override
    public int hashCode() {
        return Objects.hash(name);
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/genre/GenreUpdateCommand.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.genre;

import javax.validation.constraints.NotBlank;
import javax.validation.constraints.NotNull;
import java.util.Objects;

public class GenreUpdateCommand {
    @NotNull
    private Long id;

    @NotNull
    @NotBlank
    private String name;

    public GenreUpdateCommand() {}

    public GenreUpdateCommand(Long id, String name) {
        this.id = id;
        this.name = name;
    }

    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        GenreUpdateCommand that = (GenreUpdateCommand) o;
        return Objects.equals(id, that.id) &amp;&amp;
                Objects.equals(name, that.name);
    }

    @Override
    public int hashCode() {
        return Objects.hash(id, name);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create several POJOs to encapsulate Sorting and Pagination:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/SortingOrder.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

public enum SortingOrder {
    ASC, DESC;

    public final static SortingOrder DEFAULT_SORTING_ORDER = SortingOrder.ASC;

    public static SortingOrder of(String str) {
        if (str != null) {
            if (ASC.toString().equalsIgnoreCase(str)) {
                return ASC;
            }
            if (DESC.toString().equalsIgnoreCase(str)) {
                return DESC;
            }
        }
        return DEFAULT_SORTING_ORDER;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/SortingArguments.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

public class SortingArguments {
    private String sort;
    private SortingOrder order;

    public SortingArguments(String sort, SortingOrder order) {
        this.sort = sort;
        this.order = order;
    }

    public String getSort() {
        return sort;
    }

    public SortingOrder getOrder() {
        return order;
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/PaginationArguments.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

public class PaginationArguments {
    Integer offset;
    Integer max;

    public PaginationArguments(Integer offset, Integer max) {
        this.offset = offset == null || offset &lt; 0 ? 0 : offset;
        this.max = max;
    }

    public Integer getOffset() {
        return offset;
    }

    public Integer getMax() {
        return max;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a <code>ConfigurationProperties</code> object to encapsulate the configuration of the default <code>max</code> value.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/ApplicationConfiguration.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

public interface ApplicationConfiguration {

    Integer getMax();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/ApplicationConfigurationProperties.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.context.annotation.ConfigurationProperties;

@ConfigurationProperties("application")
public class ApplicationConfigurationProperties implements ApplicationConfiguration {

    protected final Integer DEFAULT_MAX = 10;

    private Integer max = DEFAULT_MAX;

    @Override
    public Integer getMax() {
        return max;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create <code>GenreController</code>, a controller which exposes a resource with the common CRUD operations:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/genre/GenreController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.genre;

import example.micronaut.ApplicationConfiguration;
import example.micronaut.PaginationArguments;
import example.micronaut.SortingArguments;
import example.micronaut.SortingOrder;
import example.micronaut.domain.Genre;
import io.micronaut.http.HttpHeaders;
import io.micronaut.http.HttpResponse;
import io.micronaut.http.annotation.Body;
import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Delete;
import io.micronaut.http.annotation.Get;
import io.micronaut.http.annotation.Post;
import io.micronaut.http.annotation.Put;
import io.micronaut.validation.Validated;

import javax.annotation.Nullable;
import javax.validation.Valid;
import java.net.URI;
import java.util.List;

@Validated <i class="conum" data-value="1"></i><b>(1)</b>
@Controller("/genres") <i class="conum" data-value="2"></i><b>(2)</b>
public class GenreController {

    protected final GenreRepository genreRepository;

    protected final ApplicationConfiguration applicationConfiguration;

    public GenreController(GenreRepository genreRepository,
                           ApplicationConfiguration applicationConfiguration) { <i class="conum" data-value="3"></i><b>(3)</b>
        this.genreRepository = genreRepository;
        this.applicationConfiguration = applicationConfiguration;
    }

    @Get("/{id}") <i class="conum" data-value="4"></i><b>(4)</b>
    public Genre show(Long id) {
        return genreRepository
                .findById(id)
                .orElse(null); <i class="conum" data-value="5"></i><b>(5)</b>
    }

    @Put("/") <i class="conum" data-value="6"></i><b>(6)</b>
    public HttpResponse update(@Body @Valid GenreUpdateCommand command) { <i class="conum" data-value="7"></i><b>(7)</b>
        int numberOfEntitiesUpdated = genreRepository.update(command.getId(), command.getName());

        return HttpResponse
                .noContent()
                .header(HttpHeaders.LOCATION, location(command.getId()).getPath()); <i class="conum" data-value="8"></i><b>(8)</b>
    }

    @Get(value = "/") <i class="conum" data-value="9"></i><b>(9)</b>
    public List&lt;Genre&gt; list(@Nullable Integer offset,
                            @Nullable Integer max,
                            @Nullable String sort,
                            @Nullable String order) {
        PaginationArguments paginationArguments = new PaginationArguments(offset != null ? offset : 0,
                max != null ? max : applicationConfiguration.getMax());
        SortingArguments sortingArguments = sort != null ? new SortingArguments(sort, SortingOrder.of(order)) : null;

        return genreRepository.findAll(paginationArguments, sortingArguments);
    }

    @Post("/") <i class="conum" data-value="10"></i><b>(10)</b>
    public HttpResponse&lt;Genre&gt; save(@Body @Valid GenreSaveCommand cmd) {
        Genre genre = genreRepository.save(cmd.getName());

        return HttpResponse
                .created(genre)
                .headers(headers -&gt; headers.location(location(genre.getId())));
    }

    @Delete("/{id}") <i class="conum" data-value="11"></i><b>(11)</b>
    public HttpResponse delete(Long id) {
        genreRepository.deleteById(id);
        return HttpResponse.noContent();
    }

    protected URI location(Long id) {
        return URI.create("/genres/" + id);
    }

    protected URI location(Genre genre) {
        return location(genre.getId());
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add <code>@Validated</code> annotation at the class level to any class that requires validation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The class is defined as a controller with the <code>@Controller</code> annotation mapped to the path <code>/genres</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Constructor injection.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Maps a <code>GET</code> request to <code>/genres/{id}</code> which attempts to show a genre. This illustrates the use of a URL path variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Returning <code>null</code> when the genre doesn&#8217;t exist makes Micronaut to response with 404 (not found).</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Maps a <code>PUT</code> request to <code>/genres</code> which attempts to update a genre.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Add <code>@Valid</code> to any method parameter which requires validation. Use a POJO supplied as a JSON payload in the request to populate command.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>It is easy to add custom headers to the response.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Maps a <code>GET</code> request to <code>/genres</code> which returns a list of genres. This mapping illustrates optional URL parameters.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Maps a <code>POST</code> request to <code>/genres</code> which attempts to save a genre.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Maps a <code>DELETE</code> request to <code>/genres/{id}</code> which attempts to remove a genre. This illustrates the use of a URL path variable.</td>
</tr>
</table>
</div>


<h2 id="tests">3.5 Tests</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-data-access-jpa-hibernate/edit/master/src/main/docs/guide/writingTheApp/tests.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a Junit test which verifies the CRUD operations:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/example/micronaut/GenreControllerTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.genre;

import static org.junit.Assert.assertEquals;

import example.micronaut.domain.Genre;
import io.micronaut.context.ApplicationContext;
import io.micronaut.core.type.Argument;
import io.micronaut.http.HttpHeaders;
import io.micronaut.http.HttpRequest;
import io.micronaut.http.HttpResponse;
import io.micronaut.http.HttpStatus;
import io.micronaut.http.client.HttpClient;
import io.micronaut.runtime.server.EmbeddedServer;
import org.junit.AfterClass;
import org.junit.BeforeClass;
import org.junit.Test;

import java.util.ArrayList;
import java.util.List;

public class GenreControllerTest {

    private static EmbeddedServer server; <i class="conum" data-value="1"></i><b>(1)</b>
    private static HttpClient client; <i class="conum" data-value="2"></i><b>(2)</b>

    @BeforeClass
    public static void setupServer() {
        server = ApplicationContext
                .build()
                .packages("example.micronaut.domain") <i class="conum" data-value="3"></i><b>(3)</b>
                .run(EmbeddedServer.class); <i class="conum" data-value="1"></i><b>(1)</b>
        client = server.getApplicationContext().createBean(HttpClient.class, server.getURL()); <i class="conum" data-value="2"></i><b>(2)</b>
    }

    @AfterClass
    public static void stopServer() {
        if (server != null) {
            server.stop();
        }
        if (client != null) {
            client.stop();
        }
    }

    @Test
    public void testGenreCrudOperations() {

        List&lt;Long&gt; genreIds = new ArrayList&lt;&gt;();

        HttpRequest request = HttpRequest.POST("/genres", new GenreSaveCommand("DevOps")); <i class="conum" data-value="4"></i><b>(4)</b>
        HttpResponse response = client.toBlocking().exchange(request);
        genreIds.add(entityId(response));

        assertEquals(HttpStatus.CREATED, response.getStatus());

        request = HttpRequest.POST("/genres", new GenreSaveCommand("Microservices")); <i class="conum" data-value="4"></i><b>(4)</b>
        response = client.toBlocking().exchange(request);

        assertEquals(HttpStatus.CREATED, response.getStatus());

        Long id = entityId(response);
        genreIds.add(id);
        request = HttpRequest.GET("/genres/"+id);

        Genre genre = client.toBlocking().retrieve(request, Genre.class); <i class="conum" data-value="5"></i><b>(5)</b>

        assertEquals("Microservices", genre.getName());

        request = HttpRequest.PUT("/genres", new GenreUpdateCommand(id, "Micro-services"));
        response = client.toBlocking().exchange(request);  <i class="conum" data-value="6"></i><b>(6)</b>

        assertEquals(HttpStatus.NO_CONTENT, response.getStatus());

        request = HttpRequest.GET("/genres/" + id);
        genre = client.toBlocking().retrieve(request, Genre.class);
        assertEquals("Micro-services", genre.getName());

        request = HttpRequest.GET("/genres");
        List&lt;Genre&gt; genres = client.toBlocking().retrieve(request, Argument.of(List.class, Genre.class));

        assertEquals(2, genres.size());

        request = HttpRequest.GET("/genres?max=1");
        genres = client.toBlocking().retrieve(request, Argument.of(List.class, Genre.class));

        assertEquals(1, genres.size());
        assertEquals("DevOps", genres.get(0).getName());

        request = HttpRequest.GET("/genres?max=1&amp;order=desc&amp;sort=name");
        genres = client.toBlocking().retrieve(request, Argument.of(List.class, Genre.class));

        assertEquals(1, genres.size());
        assertEquals("Micro-services", genres.get(0).getName());

        request = HttpRequest.GET("/genres?max=1&amp;offset=10");
        genres = client.toBlocking().retrieve(request, Argument.of(List.class, Genre.class));

        assertEquals(0, genres.size());

        // cleanup:
        for (Long genreId : genreIds) {
            request = HttpRequest.DELETE("/genres/"+genreId);
            response = client.toBlocking().exchange(request);
            assertEquals(HttpStatus.NO_CONTENT, response.getStatus());
        }
    }

    protected Long entityId(HttpResponse response) {
        String path = "/genres/";
        String value = response.header(HttpHeaders.LOCATION);
        if ( value == null) {
            return null;
        }
        int index = value.indexOf(path);
        if ( index != -1) {
            return Long.valueOf(value.substring(index + path.length()));
        }
        return null;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To run the application from a unit test you can use the <a href="http://docs.micronaut.io/latest/api/io/micronaut/runtime/server/EmbeddedServer.html">EmbeddedServer</a> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Register a <code>HttpClient</code> bean in the application context and point it to the embedded server URL. The EmbeddedServer interface provides the URL of the server under test which runs on a random port.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>As the test&#8217;s package is not the same as the entities (<code>example.micronaut.genre</code> vs <code>example.micronaut.domain</code>) it is necessary to specify the packages to scan for entities.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Creating HTTP Requests is easy thanks to Micronaut&#8217;s fluid API.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>If you care just about the object in the response use <code>retrieve</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Sometimes, receiving just the object is not enough and you need information about the response. In this case, instead of <code>retrieve</code> you should use the <code>exchange</code> method.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ./gradlew test
$ open build/reports/tests/test/index.html</code></pre>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/usingSnapshotVersion.html">&lt;&lt; <strong>2</strong><span>Using Snapshot Version</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/runningTheApp.html"><strong>4</strong><span>Running the app</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
