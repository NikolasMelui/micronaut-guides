<!DOCTYPE html>
<html>
<head>
    <meta name='google-site-verification' content='REYQ1_I6HGowAE7LOLVqfQbnKaB4IfFpMlGzMbJj55Q' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='../img/micronaut-favicon.ico' />
    <meta charset='UTF-8' />
    <title>Microservices discovery service with Consul and Micronaut | Micronaut Guides | Micronaut Framework</title>
    <meta name='description' content='Microservices discovery service with Consul and Micronaut. Use Consul service discovery to expose your Micronaut apps.' />
    <link rel='stylesheet' href='../css/main.css' />
    <link rel='stylesheet' href='../css/screen.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js'></script>
</head>
<body class='guide'>
<div id="navigation">
    <div class="navTitle">
        <span id="logo"><a href="http://micronaut.io" title="Go to Micronaut Website"><img src="../img/micronaut-logo-white.svg" alt="Micronaut"/></a></span>
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <a href="http://guides.micronaut.io">Micronaut Guides</a>
                <span> &rarr; </span>
                <a href="http://guides.micronaut.io/micronaut-microservices-services-discover-consul/guide/index.html">Microservices discovery service with Consul and Micronaut</a>
            </li>
        </ul>

    </div>
</div>

<div class='fullwidth'><article class="guide">
    <aside>
        <a href="https://travis-ci.org/micronaut-guides/micronaut-microservices-services-discover-consul"><img src="https://travis-ci.org/micronaut-guides/micronaut-microservices-services-discover-consul.svg?branch=master"></a>

        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul&quot;"><img height="15" src="../img/github_white.svg" alt="Github"/><span>&nbsp;Get the Code</span></button>


        <ul class="githublinks">
            <li><button type="button" class="btn btn-default" href="#" onclick="document.getElementById('github-url').value='git@github.com:micronaut-guides/micronaut-microservices-services-discover-consul.git'" class="codeButton">SSH</button></li>
            <li><button type="button" class="btn btn-default" onclick="document.getElementById('github-url').value='https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul.git'" class="codeButton">HTTPS</button></li>
        </ul>
        <div class="input-group">
            <!-- Target -->
            <input id="github-url" value="git@github.com:micronaut-guides/micronaut-microservices-services-discover-consul.git" type="text" />
            <!-- Trigger -->
            <button type="button" class="clippy btn btn-default" type="button" data-clipboard-target="#github-url">
                <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
            </button>
        </div>
        <script>var clipboard = new Clipboard('.clippy');</script>
        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/archive/master.zip&quot;">Download ZIP</button>
        
        <div id="table-of-content">
            <h3>Table of Contents</h3>
            
            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>1</strong><span>Getting Started</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>1.1</strong><span>What you will need</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#solution"><strong>1.2</strong><span>Solution</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>2</strong><span>Writing the App</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#bookcatalogue"><strong>2.1</strong><span>Catalogue Microservice</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#bookinventory"><strong>2.2</strong><span>Inventory Microservice</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#bookrecommendation"><strong>2.3</strong><span>Recommendation Microservice</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#runningTheApp"><strong>3</strong><span>Running the app</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#consul"><strong>4</strong><span>Consul and Micronaut</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#consulinstall"><strong>4.1</strong><span>Install Consul via Docker</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#micronautandconsul"><strong>4.2</strong><span>Integrate Consul</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#bookcatalogueChanges"><strong>4.3</strong><span>Book Catalogue</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#bookinventoryChanges"><strong>4.4</strong><span>Book Inventory</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#bookrecommendationChanges"><strong>4.5</strong><span>Book Recommendation</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#runningTheAppAfterConsul"><strong>4.6</strong><span>Running the App</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#nextSteps"><strong>5</strong><span>Next Steps</span></a></div>
            
            <div style="clear:both" ></div>
        </div>
        
    </aside>
    <header>
        <h1>Microservices discovery service with Consul and Micronaut</h1>
        <p>Use Consul service discovery to expose your Micronaut apps.</p>
        <p><strong>Authors:</strong> Sergio del Amo</p>
        <p><strong>Micronaut Version:</strong> 1.0.0.M3</p>
    </header>
    

<h1 id="gettingStarted">1 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In this guide, we are going to create three microservices and register them with <a href="https://www.consul.io">Consul</a> Service discovery.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Consul is a distributed service mesh to connect, secure, and configure services across any runtime platform and public or private cloud</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>You will discover how Micronaut eases Consul integration.</p>
</div>


<h2 id="requirements">1.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>


<h2 id="solution">1.2 Solution</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/solution.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We recommend you to follow the instructions in the next sections and create the app step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository: <code>git clone <a href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul.git" class="bare">https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, <code>cd</code> into the <code>complete</code> folder which you will find in the root project of the downloaded/cloned project.</p>
</div>


<h1 id="writingTheApp">2 Writing the App</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Lets describe the microservices you are going to build through the tutorial.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bookcatalogue</code> - It returns a list of books. It uses a domain consisting of a book name and isbn.</p>
</li>
<li>
<p><code>bookinventory</code> - It exposes an endpoint to check whether a book has sufficient stock to fullfil an order.  I uses a domain consisting of a stock level and isbn.</p>
</li>
<li>
<p><code>bookrecommendation</code> - It consumes previous services and exposes and endpoint which recommends book names which are in stock.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Initially we are going to hardcode the addresses where the different services are in the <code>bookcatalogue</code> service.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/hardcoded.svg" alt="hardcoded">
</div>
</div>
<div class="paragraph">
<p>As shown in the previous image, the <code>bookcatalogue</code> hardcodes references to its collaborators.</p>
</div>
<div class="paragraph">
<p>In the second part of this tutorial we are going to use a discovery service.</p>
</div>
<div class="paragraph">
<p>o learn about registration patterns:</p>
</div>
<div class="paragraph">
<p>We will use a <strong>self‑registration pattern</strong>. Thus, each service instance is responsible for registering and
deregistering itself with the service registry.
Also, if required, a service instance sends heartbeat requests to prevent its registration from expiring.</p>
</div>
<div class="paragraph">
<p>Services register when they start up:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/discovery-service-registration.svg" alt="discovery service registration">
</div>
</div>
<div class="paragraph">
<p>We will use <strong>client‑side service discovery</strong>, clients query the service registry,
select an available instance, and make a request.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/discovery-service-flow.svg" alt="discovery service flow">
</div>
</div>
<div class="paragraph">
<p>If you are using Java or Kotlin and IntelliJ IDEA make sure you have enabled annotation processing.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/annotationprocessorsintellij.png" alt="annotationprocessorsintellij">
</div>
</div>


<h2 id="bookcatalogue">2.1 Catalogue Microservice</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheApp/bookcatalogue.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create the <code>bookcatalogue</code> microservice:</p>
</div>
<div class="paragraph">
<p><code>mn create-app example.micronaut.bookcatalogue.bookcatalogue</code></p>
</div>
<div class="paragraph">
<p>The previous command creates a folder named <code>bookcatalogue</code> and a Micronaut app inside it with
default package: <code>example.micronaut.bookcatalogue</code>.</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/main/java/example/micronaut/bookcatalogue/BooksController.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookcatalogue</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Controller</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.reactivex.Flowable</span>;

<span class="keyword">import</span> <span class="include">java.util.Arrays</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Controller</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BooksController</span> {

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; index() {
        <span class="predefined-type">Book</span> buildingMicroservices = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1491950358</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Building Microservices</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">Book</span> releaseIt = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1680502395</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Release It!</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">Book</span> cidelivery = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">0321601912</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Continuous Delivery:</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> <span class="predefined-type">Arrays</span>.asList(buildingMicroservices, releaseIt, cidelivery);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="http://docs.micronaut.io/snapshot/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/books</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>@Get</code> annotation is used to map the index method to <code>/books</code> requests that use an HTTP GET.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You can return reactive types from your controller methods.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous controller responds a <code>Flowable&lt;Book&gt;</code>. Create the <code>Book</code> POJO:</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/main/java/example/micronaut/bookcatalogue/Book.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookcatalogue</span>;

<span class="keyword">import</span> <span class="include">java.util.Objects</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> isbn;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {}

    <span class="directive">public</span> <span class="predefined-type">Book</span>(<span class="predefined-type">String</span> isbn, <span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.isbn = isbn;
        <span class="local-variable">this</span>.name =  name;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getIsbn() {
        <span class="keyword">return</span> isbn;
    }

    <span class="directive">public</span> <span class="type">void</span> setIsbn(<span class="predefined-type">String</span> isbn) {
        <span class="local-variable">this</span>.isbn = isbn;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> name;
    }

    <span class="directive">public</span> <span class="type">void</span> setName(<span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.name = name;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> equals(<span class="predefined-type">Object</span> o) {
        <span class="keyword">if</span> (<span class="local-variable">this</span> == o) <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        <span class="keyword">if</span> (o == <span class="predefined-constant">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        <span class="predefined-type">Book</span> book = (<span class="predefined-type">Book</span>) o;
        <span class="keyword">return</span> Objects.equals(isbn, book.isbn) &amp;&amp;
                Objects.equals(name, book.name);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">int</span> hashCode() {

        <span class="keyword">return</span> Objects.hash(isbn, name);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write a test:</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/test/java/example/micronaut/bookcatalogue/BooksControllerTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookcatalogue</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.context.ApplicationContext</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.core.type.Argument</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.HttpClient</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.RxStreamingHttpClient</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.runtime.server.EmbeddedServer</span>;
<span class="keyword">import</span> <span class="include">org.junit.AfterClass</span>;
<span class="keyword">import</span> <span class="include">org.junit.BeforeClass</span>;
<span class="keyword">import</span> <span class="include">org.junit.Test</span>;

<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.Assert.assertEquals</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.Assert.assertTrue</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BooksControllerTest</span> {
    <span class="directive">private</span> <span class="directive">static</span> EmbeddedServer server;
    <span class="directive">private</span> <span class="directive">static</span> HttpClient client;

    <span class="annotation">@BeforeClass</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> setupServer() {
        server = ApplicationContext.run(EmbeddedServer.class);
        client = server
                .getApplicationContext()
                .createBean(HttpClient.class, server.getURL());
    }

    <span class="annotation">@AfterClass</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> stopServer() {
        <span class="keyword">if</span>(server != <span class="predefined-constant">null</span>) {
            server.stop();
        }
        <span class="keyword">if</span>(client != <span class="predefined-constant">null</span>) {
            client.stop();
        }
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testRetrieveBooks() {
        HttpRequest request = HttpRequest.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="predefined-type">List</span> books = client.toBlocking().retrieve(request, Argument.of(<span class="predefined-type">List</span>.class, <span class="predefined-type">Book</span>.class)); <i class="conum" data-value="3"></i><b>(3)</b>
        assertEquals(<span class="integer">3</span>, books.size());
        assertTrue(books.contains(<span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1491950358</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Building Microservices</span><span class="delimiter">&quot;</span></span>)));
        assertTrue(books.contains(<span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1680502395</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Release It!</span><span class="delimiter">&quot;</span></span>)));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For JUnit you can write methods to start and stop the server for the scope of the test</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It is easy to create HTTP requests with a fluid API.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Parse easily JSON into Java objects.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <code>application.yml</code></p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
    <span class="key">application</span>:
        <span class="key">name</span>: <span class="string"><span class="content">bookcatalogue </span></span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="key">server</span>:
        <span class="key">port</span>: <span class="string"><span class="content">8081 </span></span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application name. The app name will be use by the discovery service.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the app to listen at port 8081</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <code>application-test.yml</code> which is used in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/main/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
    <span class="key">server</span>:
        <span class="key">port</span>: <span class="string"><span class="content">-1 </span></span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start the micronaut microservice at a random port when running the tests.</td>
</tr>
</table>
</div>


<h2 id="bookinventory">2.2 Inventory Microservice</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheApp/bookinventory.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create the <code>bookinventory</code> microservice:</p>
</div>
<div class="paragraph">
<p><code>mn create-app example.micronaut.bookinventory.bookinventory</code></p>
</div>
<div class="paragraph">
<p>Modify <code>build.gradle</code> to add validation capabilities.</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">io.micronaut:validation</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">io.micronaut.configuration:hibernate-validator</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous command creates a folder named <code>bookinventory</code> and a Micronaut app inside it with
default package: <code>example.micronaut.bookinventory</code>.</p>
</div>
<div class="paragraph">
<p>Create a Controller:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/main/java/example/micronaut/bookinventory/BooksController.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookinventory</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.http.MediaType</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Controller</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Produces</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.validation.Validated</span>;
<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotBlank</span>;
<span class="keyword">import</span> <span class="include">java.util.Optional</span>;

<span class="annotation">@Validated</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Controller</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BooksController</span> {

    <span class="annotation">@Produces</span>(MediaType.TEXT_PLAIN) <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/stock/{isbn}</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="directive">public</span> <span class="predefined-type">Boolean</span> stock(<span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> isbn) {
        Optional&lt;BookInventory&gt; bookInventoryOptional = bookInventoryByIsbn(isbn);
        <span class="keyword">if</span> (!bookInventoryOptional.isPresent()) {
           <span class="keyword">return</span> <span class="predefined-constant">null</span>; <i class="conum" data-value="5"></i><b>(5)</b>
        }
        BookInventory bookInventory = bookInventoryOptional.get();
        <span class="keyword">return</span> bookInventory.getStock() &gt; <span class="integer">0</span> ? <span class="predefined-type">Boolean</span>.TRUE : <span class="predefined-type">Boolean</span>.FALSE;
    }

    <span class="directive">private</span> Optional&lt;BookInventory&gt; bookInventoryByIsbn(<span class="predefined-type">String</span> isbn) {
        <span class="keyword">if</span>(isbn.equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">1491950358</span><span class="delimiter">&quot;</span></span>)) {
            <span class="keyword">return</span> Optional.of(<span class="keyword">new</span> BookInventory(isbn, <span class="integer">4</span>));

        } <span class="keyword">else</span> <span class="keyword">if</span>(isbn.equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">1680502395</span><span class="delimiter">&quot;</span></span>)) {
            <span class="keyword">return</span> Optional.of(<span class="keyword">new</span> BookInventory(isbn, <span class="integer">0</span>));
        }
        <span class="keyword">return</span> Optional.empty();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define <a href="https://docs.micronaut.io/snapshot/api/io/micronaut/validation/Validated.html">Validated</a> annotation at the class level to signal any class that requires validation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The class is defined as a controller with the <a href="http://docs.micronaut.io/snapshot/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/books</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>By default a Micronaut&#8217;s response uses <code>application/json</code> as <code>Content-Type</code>. We are returning a String not a JSON object. Because of that, we set it to <code>text/plain</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>@Get</code> annotation is used to map the index method to <code>/books/stock/{isbn}</code> requests that use an HTTP GET.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous controller uses a POJO:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/main/java/example/micronaut/bookinventory/BookInventory.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookinventory</span>;

<span class="keyword">import</span> <span class="include">java.util.Objects</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BookInventory</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> isbn;
    <span class="directive">private</span> <span class="predefined-type">Integer</span> stock;

    <span class="directive">public</span> BookInventory() {}

    <span class="directive">public</span> BookInventory(<span class="predefined-type">String</span> isbn, <span class="predefined-type">Integer</span> stock) {
        <span class="local-variable">this</span>.isbn = isbn;
        <span class="local-variable">this</span>.stock =  stock;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getIsbn() {
        <span class="keyword">return</span> isbn;
    }

    <span class="directive">public</span> <span class="type">void</span> setIsbn(<span class="predefined-type">String</span> isbn) {
        <span class="local-variable">this</span>.isbn = isbn;
    }

    <span class="directive">public</span> <span class="predefined-type">Integer</span> getStock() {
        <span class="keyword">return</span> stock;
    }

    <span class="directive">public</span> <span class="type">void</span> setStock(<span class="predefined-type">Integer</span> stock) {
        <span class="local-variable">this</span>.stock = stock;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> equals(<span class="predefined-type">Object</span> o) {
        <span class="keyword">if</span> (<span class="local-variable">this</span> == o) <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        <span class="keyword">if</span> (o == <span class="predefined-constant">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        BookInventory that = (BookInventory) o;
        <span class="keyword">return</span> Objects.equals(isbn, that.isbn) &amp;&amp;
                Objects.equals(stock, that.stock);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">int</span> hashCode() {

        <span class="keyword">return</span> Objects.hash(isbn, stock);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write a test:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/test/java/example/micronaut/bookinventory/BooksControllerTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookinventory</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.context.ApplicationContext</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpResponse</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpStatus</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.RxHttpClient</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.exceptions.HttpClientResponseException</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.runtime.server.EmbeddedServer</span>;
<span class="keyword">import</span> <span class="include">org.junit.AfterClass</span>;
<span class="keyword">import</span> <span class="include">org.junit.BeforeClass</span>;
<span class="keyword">import</span> <span class="include">org.junit.Test</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.Assert.assertEquals</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.Assert.assertFalse</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.Assert.assertTrue</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BooksControllerTest</span> {

    <span class="directive">private</span> <span class="directive">static</span> EmbeddedServer server;
    <span class="directive">private</span> <span class="directive">static</span> RxHttpClient rxHttpClient;

    <span class="annotation">@BeforeClass</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> setupServer() {
        server = ApplicationContext.run(EmbeddedServer.class);
        rxHttpClient = server
                .getApplicationContext()
                .createBean(RxHttpClient.class, server.getURL());
    }

    <span class="annotation">@AfterClass</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> stopServer() {
        <span class="keyword">if</span> (server != <span class="predefined-constant">null</span>) {
            server.stop();
        }
        <span class="keyword">if</span> (rxHttpClient != <span class="predefined-constant">null</span>) {
            rxHttpClient.stop();
        }
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testBooksController() {
        <span class="type">boolean</span> noExceptionThrown = <span class="predefined-constant">true</span>;
        HttpResponse&lt;<span class="predefined-type">Boolean</span>&gt; rsp = <span class="predefined-constant">null</span>;
        <span class="keyword">try</span> {
            rsp = rxHttpClient.toBlocking().exchange(HttpRequest.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books/stock/1491950358</span><span class="delimiter">&quot;</span></span>), <span class="predefined-type">Boolean</span>.class);
        } <span class="keyword">catch</span> (HttpClientResponseException e) {
            noExceptionThrown = <span class="predefined-constant">false</span>;
        }

        assertTrue(noExceptionThrown);
        assertEquals(rsp.status(), HttpStatus.OK);
        assertTrue(rsp.body());

    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testBooksControllerWithNonExistingIsbn() {
        HttpClientResponseException ex = <span class="predefined-constant">null</span>;
        <span class="type">boolean</span> noExceptionThrown = <span class="predefined-constant">true</span>;
        <span class="keyword">try</span> {
            rxHttpClient.toBlocking().exchange(HttpRequest.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books/stock/XXXXX</span><span class="delimiter">&quot;</span></span>), <span class="predefined-type">Boolean</span>.class);
        } <span class="keyword">catch</span> (HttpClientResponseException e) {
            noExceptionThrown = <span class="predefined-constant">false</span>;
            ex = e;
        }

        assertFalse(noExceptionThrown);

        HttpResponse response = ex.getResponse();

        assertEquals(response.getStatus(), HttpStatus.NOT_FOUND);

    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For JUnit you can write methods to start and stop the server for the scope of the test</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <code>application.yml</code></p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
    <span class="key">application</span>:
        <span class="key">name</span>: <span class="string"><span class="content">bookinventory </span></span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="key">server</span>:
        <span class="key">port</span>: <span class="string"><span class="content">8082 </span></span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application name. The app name will be used later in the tutorial.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the app to listen at port 8082</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <code>application-test.yml</code> which is used in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/main/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
    <span class="key">server</span>:
        <span class="key">port</span>: <span class="string"><span class="content">-1 </span></span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start the micronaut microservice at a random port when running the tests.</td>
</tr>
</table>
</div>


<h2 id="bookrecommendation">2.3 Recommendation Microservice</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/writingTheApp/bookrecommendation.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create the <code>bookrecommendation</code> microservice:</p>
</div>
<div class="paragraph">
<p><code>mn create-app example.micronaut.bookrecommendation.bookrecommendation</code></p>
</div>
<div class="paragraph">
<p>The previous command creates a folder named <code>bookrecommendation</code> and a Micronaut app inside it with
default package: <code>example.micronaut.bookrecommendation</code>.</p>
</div>
<div class="paragraph">
<p>Create an interface to map operations with <code>bookcatalogue</code> and a Micronaut Declarative HTTP Client to consume it.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/java/example/micronaut/bookrecommendation/BookCatalogueOperations.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookrecommendation</span>;

<span class="keyword">import</span> <span class="include">io.reactivex.Flowable</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">BookCatalogueOperations</span> {
    Flowable&lt;<span class="predefined-type">Book</span>&gt; findAll();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/java/example/micronaut/bookrecommendation/BookCatalogueClient.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookrecommendation</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.Client</span>;
<span class="keyword">import</span> <span class="include">io.reactivex.Flowable</span>;

<span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8081</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">BookCatalogueClient</span> <span class="directive">extends</span> BookCatalogueOperations {

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>)
    Flowable&lt;<span class="predefined-type">Book</span>&gt; findAll();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/snapshot/guide/index.html#clientAnnotation">declarative HTTP Clients</a></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The client returns a POJO. Create it in the <code>bookrecommendation</code>:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/java/example/micronaut/bookrecommendation/Book.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookrecommendation</span>;

<span class="keyword">import</span> <span class="include">java.util.Objects</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">Book</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> isbn;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> <span class="predefined-type">Book</span>() {}

    <span class="directive">public</span> <span class="predefined-type">Book</span>(<span class="predefined-type">String</span> isbn, <span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.isbn = isbn;
        <span class="local-variable">this</span>.name =  name;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getIsbn() {
        <span class="keyword">return</span> isbn;
    }

    <span class="directive">public</span> <span class="type">void</span> setIsbn(<span class="predefined-type">String</span> isbn) {
        <span class="local-variable">this</span>.isbn = isbn;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> name;
    }

    <span class="directive">public</span> <span class="type">void</span> setName(<span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.name = name;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> equals(<span class="predefined-type">Object</span> o) {
        <span class="keyword">if</span> (<span class="local-variable">this</span> == o) <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        <span class="keyword">if</span> (o == <span class="predefined-constant">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        <span class="predefined-type">Book</span> book = (<span class="predefined-type">Book</span>) o;
        <span class="keyword">return</span> Objects.equals(isbn, book.isbn) &amp;&amp;
                Objects.equals(name, book.name);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">int</span> hashCode() {

        <span class="keyword">return</span> Objects.hash(isbn, name);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create an interface to map operations with <code>bookinventory</code> and a Micronaut Declarative HTTP Client to consume it.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/java/example/micronaut/bookrecommendation/BookInventoryOperations.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookrecommendation</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.QueryValue</span>;
<span class="keyword">import</span> <span class="include">io.reactivex.Maybe</span>;

<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotBlank</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">BookInventoryOperations</span> {
    Maybe&lt;<span class="predefined-type">Boolean</span>&gt; stock(<span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> isbn);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/java/example/micronaut/bookrecommendation/BookInventoryClient.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookrecommendation</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpResponse</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.QueryValue</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.Client</span>;
<span class="keyword">import</span> <span class="include">io.reactivex.Maybe</span>;
<span class="keyword">import</span> <span class="include">io.reactivex.Single</span>;

<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotBlank</span>;

<span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8082</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">BookInventoryClient</span> <span class="directive">extends</span> BookInventoryOperations {

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books/stock/{isbn}</span><span class="delimiter">&quot;</span></span>)
    Maybe&lt;<span class="predefined-type">Boolean</span>&gt; stock(<span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> isbn);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/snapshot/guide/index.html#clientAnnotation">declarative HTTP Clients</a></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a Controller which injects both clients.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/java/example/micronaut/bookrecommendation/BookController.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookrecommendation</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Controller</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.reactivex.Flowable</span>;

<span class="annotation">@Controller</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BookController</span> {

    <span class="directive">private</span> <span class="directive">final</span> BookCatalogueOperations bookCatalogueOperations;
    <span class="directive">private</span> <span class="directive">final</span> BookInventoryOperations bookInventoryOperations;

    <span class="directive">public</span> BookController(BookCatalogueOperations bookCatalogueOperations,
                          BookInventoryOperations bookInventoryOperations) { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="local-variable">this</span>.bookCatalogueOperations = bookCatalogueOperations;
        <span class="local-variable">this</span>.bookInventoryOperations = bookInventoryOperations;
    }


    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">public</span> Flowable&lt;BookRecommendation&gt; index() {
        <span class="keyword">return</span> bookCatalogueOperations.findAll()
                .flatMapMaybe(b -&gt; bookInventoryOperations.stock(b.getIsbn())
                        .filter(<span class="predefined-type">Boolean</span>::booleanValue)
                        .map(rsp -&gt; b)
                ).map(book -&gt; <span class="keyword">new</span> BookRecommendation(book.getName()));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="http://docs.micronaut.io/snapshot/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/books</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Constructor injection</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>@Get</code> annotation is used to map the index method to <code>/books</code> requests that use an HTTP GET.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous controller returns a <code>Flowable&lt;BookRecommendation&gt;</code>. Create the <code>BookRecommendation</code> POJO:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/java/example/micronaut/bookrecommendation/BookRecommendation.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookrecommendation</span>;

<span class="keyword">import</span> <span class="include">java.util.Objects</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BookRecommendation</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> BookRecommendation() {}

    <span class="directive">public</span> BookRecommendation(<span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.name = name;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> name;
    }

    <span class="directive">public</span> <span class="type">void</span> setName(<span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.name = name;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> equals(<span class="predefined-type">Object</span> o) {
        <span class="keyword">if</span> (<span class="local-variable">this</span> == o) <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        <span class="keyword">if</span> (o == <span class="predefined-constant">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        BookRecommendation that = (BookRecommendation) o;
        <span class="keyword">return</span> Objects.equals(name, that.name);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">int</span> hashCode() {

        <span class="keyword">return</span> Objects.hash(name);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>BookCatalogueClient</code> and <code>BookInventoryClient</code> will fail to consume the <code>bookcatalogue</code> and <code>bookinventory</code> during the tests phase.</p>
</div>
<div class="paragraph">
<p>Using the <a href="https://docs.micronaut.io/snapshot/guide/index.html#clientFallback">@Fallback</a> annotation you can declare a fallback implementation of a client that will be picked up and used once all possible retries have been exhausted</p>
</div>
<div class="paragraph">
<p>Create <code>@Fallback</code> alternatives in the <code>test</code> classpath.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/test/java/example/micronaut/bookrecommendation/BookInventoryClientStub.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookrecommendation</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.Requires</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.context.env.Environment</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpResponse</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.QueryValue</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.retry.annotation.Fallback</span>;
<span class="keyword">import</span> <span class="include">io.reactivex.Maybe</span>;
<span class="keyword">import</span> <span class="include">io.reactivex.Single</span>;

<span class="keyword">import</span> <span class="include">javax.inject.Singleton</span>;
<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotBlank</span>;

<span class="annotation">@Requires</span>(env = Environment.TEST)
<span class="annotation">@Fallback</span>
<span class="annotation">@Singleton</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BookInventoryClientStub</span> <span class="directive">implements</span> BookInventoryOperations {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Maybe&lt;<span class="predefined-type">Boolean</span>&gt; stock(<span class="annotation">@QueryValue</span> <span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> isbn) {
        <span class="keyword">if</span>(isbn.equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">1491950358</span><span class="delimiter">&quot;</span></span>)) {
            <span class="keyword">return</span> Maybe.just(<span class="predefined-type">Boolean</span>.TRUE);

        } <span class="keyword">else</span> <span class="keyword">if</span>(isbn.equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">1680502395</span><span class="delimiter">&quot;</span></span>)) {
            <span class="keyword">return</span> Maybe.just(<span class="predefined-type">Boolean</span>.FALSE);
        }
        <span class="keyword">return</span> Maybe.empty();
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/test/java/example/micronaut/bookrecommendation/BookCatalogueClientStub.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookrecommendation</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.Requires</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.context.env.Environment</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.retry.annotation.Fallback</span>;
<span class="keyword">import</span> <span class="include">io.reactivex.Flowable</span>;

<span class="keyword">import</span> <span class="include">javax.inject.Singleton</span>;

<span class="annotation">@Requires</span>(env = Environment.TEST)
<span class="annotation">@Fallback</span>
<span class="annotation">@Singleton</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">BookCatalogueClientStub</span> <span class="directive">implements</span> BookCatalogueOperations {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Flowable&lt;<span class="predefined-type">Book</span>&gt; findAll() {
        <span class="predefined-type">Book</span> buildingMicroservices = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1491950358</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Building Microservices</span><span class="delimiter">&quot;</span></span>);
        <span class="predefined-type">Book</span> releaseIt = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1680502395</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Release It!</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> Flowable.just(buildingMicroservices, releaseIt);    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write a test:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/test/java/example/micronaut/bookrecommendation/BookControllerTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookrecommendation</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.context.ApplicationContext</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.RxStreamingHttpClient</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.runtime.server.EmbeddedServer</span>;
<span class="keyword">import</span> <span class="include">io.reactivex.Flowable</span>;
<span class="keyword">import</span> <span class="include">org.junit.AfterClass</span>;
<span class="keyword">import</span> <span class="include">org.junit.BeforeClass</span>;
<span class="keyword">import</span> <span class="include">org.junit.Test</span>;
<span class="keyword">import</span> <span class="include">java.util.Collections</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.Assert.assertEquals</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">BookControllerTest</span> {
    <span class="directive">private</span> <span class="directive">static</span> EmbeddedServer server;
    <span class="directive">private</span> <span class="directive">static</span> RxStreamingHttpClient client;

    <span class="annotation">@BeforeClass</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> setupServer() {
        server = ApplicationContext.run(EmbeddedServer.class);
        client = server
                .getApplicationContext()
                .createBean(RxStreamingHttpClient.class, server.getURL());
    }

    <span class="annotation">@AfterClass</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> stopServer() {
        <span class="keyword">if</span>(server != <span class="predefined-constant">null</span>) {
            server.stop();
        }
        <span class="keyword">if</span>(client != <span class="predefined-constant">null</span>) {
            client.stop();
        }
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testRetrieveBooks() <span class="directive">throws</span> <span class="exception">Exception</span> {
        Flowable&lt;BookRecommendation&gt; books = client.jsonStream(HttpRequest.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>), BookRecommendation.class);
        assertEquals(books.toList().blockingGet().size(), <span class="integer">1</span>);
        assertEquals(books.toList().blockingGet().get(<span class="integer">0</span>).getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">Building Microservices</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For JUnit you can write methods to start and stop the server for the scope of the test</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <code>application.yml</code></p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
    <span class="key">application</span>:
        <span class="key">name</span>: <span class="string"><span class="content">bookrecommendation </span></span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="key">server</span>:
        <span class="key">port</span>: <span class="string"><span class="content">8080 </span></span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application name. The app name will be used later in the tutorial.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the app to listen at port 8080</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <code>application-test.yml</code> which is used in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
    <span class="key">server</span>:
        <span class="key">port</span>: <span class="string"><span class="content">-1 </span></span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start the micronaut microservice at a random port when running the tests.</td>
</tr>
</table>
</div>


<h1 id="runningTheApp">3 Running the app</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/runningTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Run <code>bookcatalogue</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">bookcatalogue $ ./gradlew run
 Starting a Gradle Daemon, 2 stopped Daemons could not be reused, use --status for details

 &gt; Task :bookcatalogue:compileJava
 Note: Creating bean classes for 1 type elements

 &gt; Task :bookcatalogue:run
 14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8081</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run <code>bookinventory</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">bookinventory $ ./gradlew run
 Starting a Gradle Daemon, 2 stopped Daemons could not be reused, use --status for details

 &gt; Task :bookinventory:compileJava
 Note: Creating bean classes for 1 type elements

 &gt; Task :bookcatalogue:run
 14:31:13.104 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8082</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run <code>bookrecommendation</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bookrecommendation $ ./gradlew run
Starting a Gradle Daemon, 2 busy and 2 stopped Daemons could not be reused, use --status for details

&gt; Task :bookrecommendation:compileJava
Note: Creating bean classes for 3 type elements

&gt; Task :bookrecommendation:run
14:31:57.389 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 523ms. Server Running: http://localhost:8080</pre>
</div>
</div>
<div class="paragraph">
<p>You can run a cURL command to test the whole application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ curl http://localhost:8080/books
[{&quot;name&quot;:&quot;Building Microservices&quot;}</code></pre>
</div>
</div>


<h1 id="consul">4 Consul and Micronaut</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/consul.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>





<h2 id="consulinstall">4.1 Install Consul via Docker</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/consul/consulinstall.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The quickest way to start using <a href="https://hub.docker.com/_/consul/">Consul is via Docker</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>docker run -p 8500:8500 consul</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively you can <a href="https://www.consul.io/docs/install/index.html">install and run a local Consul instance</a>.</p>
</div>
<div class="paragraph">
<p>The following screenshots show how to install/run Consul via <a href="https://kitematic.com">Kitematic</a>; graphical user interface for Docker.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/kitematic-consul-1.png" alt="kitematic consul 1">
</div>
</div>
<div class="paragraph">
<p>Configure ports:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/kitematic-consul-2.png" alt="kitematic consul 2">
</div>
</div>


<h2 id="micronautandconsul">4.2 Integrate Consul</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/consul/micronautandconsul.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>





<h2 id="bookcatalogueChanges">4.3 Book Catalogue</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/consul/bookcatalogueChanges.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Modify <code>build.gradle</code> to add <code>discovery-client</code> dependency.</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">dependencies {
    ...
    ..
    .
    runtime <span class="string"><span class="delimiter">&quot;</span><span class="content">io.micronaut:discovery-client</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Append to <code>bookcatalogue</code> service <code>application.yml</code> the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">consul</span>:
  <span class="key">client</span>:
    <span class="key">registration</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">defaultZone</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">${CONSUL_HOST:localhost}:${CONSUL_PORT:8500}</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Previous configuration registers a Micronaut app with Consul with minimal configuration. Discover a more complete list of Configuration options at <a href="https://docs.micronaut.io/snapshot/api/io/micronaut/discovery/consul/ConsulConfiguration.html">ConsulConfiguration</a>.</p>
</div>
<div class="paragraph">
<p>Disable consul registration in tests:</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/main/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">consul</span>:
    <span class="key">client</span>:
        <span class="key">registration</span>:
            <span class="key">enabled</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>


<h2 id="bookinventoryChanges">4.4 Book Inventory</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/consul/bookinventoryChanges.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Modify <code>build.gradle</code> to add <code>discovery-client</code> dependency.</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">dependencies {
    ...
    ..
    .
    runtime <span class="string"><span class="delimiter">&quot;</span><span class="content">io.micronaut:discovery-client</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, modify the <code>application.yml</code> of the <code>bookinventory</code> application with the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">consul</span>:
  <span class="key">client</span>:
    <span class="key">registration</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">defaultZone</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">${CONSUL_HOST:localhost}:${CONSUL_PORT:8500}</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Disable consul registration in tests:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/main/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">consul</span>:
    <span class="key">client</span>:
        <span class="key">registration</span>:
            <span class="key">enabled</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>


<h2 id="bookrecommendationChanges">4.5 Book Recommendation</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/consul/bookrecommendationChanges.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Modify <code>build.gradle</code> to add <code>discovery-client</code> dependency.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">dependencies {
    ...
    ..
    .
    runtime <span class="string"><span class="delimiter">&quot;</span><span class="content">io.micronaut:discovery-client</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, append to <code>bookrecommendation</code>.<code>application.yml</code> the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">consul</span>:
  <span class="key">client</span>:
    <span class="key">registration</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">defaultZone</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">${CONSUL_HOST:localhost}:${CONSUL_PORT:8500}</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify <code>BookInventoryClient</code> and <code>BookCatalogueClient</code> to use the service id instead of a harcoded ip.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/java/example/micronaut/bookrecommendation/BookCatalogueClient.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookrecommendation</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.Client</span>;
<span class="keyword">import</span> <span class="include">io.reactivex.Flowable</span>;

<span class="annotation">@Client</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">bookcatalogue</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">BookCatalogueClient</span> <span class="directive">extends</span> BookCatalogueOperations {

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>)
    Flowable&lt;<span class="predefined-type">Book</span>&gt; findAll();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the configuration value <code>micronaut.application.name</code> used in <code>bookcatalogue</code> as service <code>id</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/java/example/micronaut/bookrecommendation/BookInventoryClient.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.bookrecommendation</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpResponse</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.QueryValue</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.Client</span>;
<span class="keyword">import</span> <span class="include">io.reactivex.Maybe</span>;
<span class="keyword">import</span> <span class="include">io.reactivex.Single</span>;

<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotBlank</span>;

<span class="annotation">@Client</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">bookinventory</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">BookInventoryClient</span> <span class="directive">extends</span> BookInventoryOperations {

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books/stock/{isbn}</span><span class="delimiter">&quot;</span></span>)
    Maybe&lt;<span class="predefined-type">Boolean</span>&gt; stock(<span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> isbn);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the configuration value <code>micronaut.application.name</code> used in <code>bookinventory</code> as service <code>id</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Disable consul registration in tests:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">consul</span>:
    <span class="key">client</span>:
        <span class="key">registration</span>:
            <span class="key">enabled</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>


<h2 id="runningTheAppAfterConsul">4.6 Running the App</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/consul/runningTheAppAfterConsul.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Run <code>bookcatalogue</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">bookcatalogue $ ./gradlew run
 Starting a Gradle Daemon, 2 stopped Daemons could not be reused, use --status for details

 &gt; Task :bookcatalogue:compileJava
 Note: Creating bean classes for 1 type elements

 &gt; Task :bookcatalogue:run
 14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8081</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run <code>bookinventory</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">bookinventory $ ./gradlew run
 Starting a Gradle Daemon, 2 stopped Daemons could not be reused, use --status for details

 &gt; Task :bookinventory:compileJava
 Note: Creating bean classes for 1 type elements

 &gt; Task :bookcatalogue:run
 14:31:13.104 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8082</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run <code>bookrecommendation</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bookrecommendation $ ./gradlew run
Starting a Gradle Daemon, 2 busy and 2 stopped Daemons could not be reused, use --status for details

&gt; Task :bookrecommendation:compileJava
Note: Creating bean classes for 3 type elements

&gt; Task :bookrecommendation:run
14:31:57.389 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 523ms. Server Running: http://localhost:8080</pre>
</div>
</div>
<div class="paragraph">
<p>Consul comes with a HTML UI. Open <a href="http://localhost:8500/ui">http://localhost:8500/ui</a> in your browser.</p>
</div>
<div class="paragraph">
<p>You will see the services registered in Consul:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/consului.png" alt="consului">
</div>
</div>
<div class="paragraph">
<p>You can run a cURL command to test the whole application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ curl http://localhost:8080/books
[{&quot;name&quot;:&quot;Building Microservices&quot;}</code></pre>
</div>
</div>


<h1 id="nextSteps">5 Next Steps</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-services-discover-consul/edit/master/src/main/docs/guide/nextSteps.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Read more about <a href="https://docs.micronaut.io/snapshot/guide/index.html#distributedConfigurationConsul">Consul support</a> inside Micronaut.</p>
</div>

</article>
</div>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115754405-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-115754405-1');
</script>
</body>
</html>
