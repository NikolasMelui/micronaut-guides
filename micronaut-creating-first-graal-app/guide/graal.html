<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>5 Adding Graal support null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Creating your first Micronaut Graal application
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/writingTheApp.html"><strong>2</strong><span>Writing the App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/service.html"><strong>3</strong><span>Service</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/controller.html"><strong>4</strong><span>Controller</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/graal.html"><strong>5</strong><span>Adding Graal support</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/nextSteps.html"><strong>6</strong><span>Next steps</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/controller.html">&lt;&lt; <strong>4</strong><span>Controller</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/nextSteps.html"><strong>6</strong><span>Next steps</span> >></a></div>
                


                <div class="project">
                    <h1>5 Adding Graal support</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#creatingGraalImage"><strong>5.1</strong><span>Creating Graal native image</span></a>
                    </div>
                    
                </div>
                

                

<h1 id="graal">5 Adding Graal support</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-creating-first-graal-app/edit/master/src/main/docs/guide/graal.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><a href="https://www.graalvm.org">GraalVM</a> is a new universal virtual machine from Oracle that supports a polyglot runtime
 environment and the ability to compile Java applications down to native machine code.</p>
</div>
<div class="paragraph">
<p>Any Micronaut application can be run using the GraalVM JVM, however special support has been added to Micronaut to
 support running Micronaut applications using
 <a href="https://www.graalvm.org/docs/reference-manual/aot-compilation/">GraalVM&#8217;s <code>nativeimage</code> tool</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Use of GraalVM&#8217;s <code>nativeimage</code> tool is only supported in Java or Kotlin projects. Groovy relies heavily on
reflection which is only partially supported by GraalVM.
</td>
</tr>
</table>
</div>


<h2 id="creatingGraalImage">5.1 Creating Graal native image</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-creating-first-graal-app/edit/master/src/main/docs/guide/graal/creatingGraalImage.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>When we created the application we used the <code>graal-native-image</code> feature. This feature adds four important items:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <a href="https://github.com/micronaut-guides/micronaut-creating-first-graal-app/blob/master/complete/src/main/java/example/micronaut/MicronautSubstitutions.java">MicronautSubstitutions.java</a>
file needed to recompute Netty and Caffeine&#8217;s use of <code>Unsafe</code>.</p>
</li>
<li>
<p><code>svm</code> and <code>graal</code> dependencies in <code>build.gradle</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">compileOnly "com.oracle.substratevm:svm"
runtime "io.micronaut:micronaut-graal"</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>Dockerfile</code> which can be used to construct the native image executing <code>docker-build.sh</code></p>
</li>
<li>
<p>A <code>build-native-image.sh</code> script to build the native image outside Docker.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_creating_native_image_inside_docker">Creating native image inside Docker</h3>
<div class="paragraph">
<p>With this approach you only need to have Docker installed because it will download the required images, if necessary.</p>
</div>
<div class="paragraph">
<p>The provided <code>Dockerfile</code> is a multi-stage dockerfile which builds the project in three steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A Gradle or Maven image will build the project</p>
</li>
<li>
<p>A GraalVM official image will build the native image</p>
</li>
<li>
<p>A typical dockerfile structure will build the final image which is smaller due to layering</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">Building Graal native image</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ./docker-build.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous command will create the image <code>complete:latest</code>. To execute it:</p>
</div>
<div class="listingblock">
<div class="title">Executing the native image</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ docker run --network host complete
10:29:46.845 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 12ms. Server Running: http://nobita:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see that the application starts in only 12ms.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
We use the option <code>--network host</code> to use the same network as the host and expose automatically all the ports
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_creating_native_image_outside_docker">Creating native image outside Docker</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For this approach you need to use Linux or Mac. As this moment GraalVM is not supported on Windows.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Building Graal native image</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ sdk use java 1.0.0-rc-12-grl
$ ./build-native-image.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous commmand will create a native executable called <code>complete</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sending_a_request">Sending a request</h3>
<div class="paragraph">
<p>Start the application either using Docker or the native executable. You can run a few cURL requests to test the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">complete $ time curl localhost:8080/conferences/random
{"name":"Oracle Code One"}
real    0m0.016s
user    0m0.005s
sys     0m0.004s

complete $ time curl localhost:8080/conferences/random
{"name":"GR8Conf EU"}
real    0m0.014s
user    0m0.005s
sys     0m0.004s</code></pre>
</div>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/controller.html">&lt;&lt; <strong>4</strong><span>Controller</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/nextSteps.html"><strong>6</strong><span>Next steps</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
